<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Vivace ç·´ç´åŠ©æ‰‹ - é™³æ¬£å®œ 2026</title>
    <style>
        :root { 
            --bg-paper: #fdf6e3; --piano-black: #2c3e50; --soft-pink: #ffdae0; 
            --mint: #b8e994; --gold: #d4a373; --wood: #8c5a44; --star-color: #f1c40f;
        }
        body { background: var(--bg-paper); font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--piano-black); }
        .app-card { width: 100%; max-width: 600px; background: #fffaf0; padding: 25px; border-radius: 30px; border: 8px solid var(--soft-pink); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .file-manager { display: flex; gap: 8px; margin-bottom: 15px; background: var(--wood); padding: 10px 20px; border-radius: 50px; color: white; align-items: center; justify-content: center; }
        .file-manager select { background: white; border-radius: 5px; padding: 3px; border: none; }

        .stats-section { background: rgba(255, 218, 224, 0.3); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed var(--gold); }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-bottom: 10px; }
        .day-box { font-size: 11px; background: white; padding: 8px 2px; border-radius: 12px; border: 1px solid var(--soft-pink); }
        .day-box.today { background: var(--mint); border: 2px solid var(--wood); }
        .reward-banner { background: var(--piano-black); color: white; padding: 12px; border-radius: 15px; text-align: center; }
        .star-display { font-size: 24px; color: var(--star-color); margin-top: 5px; min-height: 30px; }

        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { border: 2px solid var(--soft-pink); padding: 15px; border-radius: 20px; background: white; text-align: center; }
        .vol-slider { width: 100%; margin: 10px 0; accent-color: var(--wood); }

        .counter-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--soft-pink); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 5px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 32px; font-weight: bold; margin: 10px auto; transition: 0.1s; user-select: none; }
        .counter-btn.flash { background: var(--gold); transform: scale(1.1); color: white; }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 10px; background: white; border-radius: 12px; margin-bottom: 8px; border: 1px solid #eee; gap: 10px; }
        .task-text { flex: 1; font-size: 15px; cursor: pointer; user-select: none; }
        .completed { background: #f0f0f0; opacity: 0.6; }

        button { cursor: pointer; border: none; border-radius: 10px; font-weight: bold; padding: 8px 12px; transition: 0.2s; }
        .btn-main { background: var(--wood); color: white; }
        .footer-credit { margin-top: 25px; font-size: 14px; color: var(--wood); opacity: 0.8; font-weight: bold; }
        input, select { padding: 4px; border-radius: 5px; border: 1px solid #ccc; font-size: 12px; }
    </style>
</head>
<body>

<div class="file-manager">
    <span>ğŸ“ å­˜æª”ï¼š</span>
    <select id="saveSelect" onchange="switchSave()"></select>
    <button onclick="createNewSave()" style="background:#444; color:white; font-size:11px;">â• æ–°å¢</button>
</div>

<div class="app-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: var(--wood);" id="displayName">ğŸ“Š ç·´ç´ç´€éŒ„</h3>
        <span style="background:var(--wood); color:white; padding:4px 12px; border-radius:15px; font-size:12px;" id="weekTotalDisplay">ç¸½è¨ˆ: 0 åˆ†</span>
    </div>
    
    <div class="stats-section">
        <div style="text-align: center; font-size: 12px; margin-bottom: 10px;">
            é€±èµ·å§‹æ—¥ï¼š<input type="date" id="weekStartDate" onchange="saveAndRefresh()">
        </div>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="reward-banner">
            <div id="starContainer" class="star-display"></div>
            <div class="star-config" style="font-size:11px; margin-top:5px;">
                â­ æ¯ <input type="number" id="starThreshold" value="30" min="1" disabled style="width: 45px; text-align: center; background: #eee;"> åˆ†/1æ˜Ÿ
                <button onclick="toggleStarLock()" id="lockBtn" style="padding: 2px 8px; font-size: 10px; background: #555; color: white;">ğŸ”‘ ç®¡ç†è¨­å®š</button>
            </div>
        </div>
    </div>

    <div class="tools-grid">
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ¥ ç¯€æ‹å™¨</h4>
            BPM: <input type="number" id="bpmInput" value="100" style="width:45px;"><br>
            <select id="beatType" style="width:100%; margin-top:5px;" onchange="currentBeat=0">
                <option value="0">ç„¡é‡éŸ³</option><option value="2">2 æ‹å­</option><option value="3">3 æ‹å­</option><option value="4">4 æ‹å­</option><option value="6">6 æ‹å­</option>
            </select>
            <div style="font-size:11px; margin-top:8px; color:var(--wood);">ğŸ”Š éŸ³é‡</div>
            <input type="range" id="volSlider" class="vol-slider" min="0" max="1" step="0.1" value="0.5">
            <button class="btn-main" onclick="toggleMetronome()" id="metroBtn" style="width:100%; margin-top:5px;">å•Ÿå‹•</button>
        </div>
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ”¢ è¨ˆæ¬¡ (æœ‰è²)</h4>
            <div class="counter-btn" onclick="handleCounterClick()" id="countNum">5</div>
            <div style="font-size: 11px; color: var(--wood);">
                è¨­å®šæ¬¡æ•¸: <input type="number" id="customCountSet" value="5" min="1" style="width: 35px; text-align: center;" oninput="syncNewStartValue()">
            </div>
            <button onclick="resetCount()" style="font-size:10px; background:none; border:1px solid #ddd; width:100%; margin-top:5px;">æ‰‹å‹•é‡ç½®</button>
        </div>
    </div>

    <div style="background: var(--soft-pink); padding: 15px; border-radius: 20px; margin-bottom: 15px;">
        <h4 style="margin:0 0 10px 0">âœ¨ å¿«é€ŸåŠ å…¥å…§å®¹ (å¤§å°èª¿)</h4>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <select id="scaleKey" style="flex:1">
                <optgroup label="--- å¤§èª¿ Major ---">
                    <option>C Major</option><option>G Major</option><option>D Major</option><option>A Major</option>
                    <option>E Major</option><option>B Major</option><option>F# Major</option><option>Gb Major</option>
                    <option>Db Major</option><option>Ab Major</option><option>Eb Major</option><option>Bb Major</option><option>F Major</option>
                </optgroup>
                <optgroup label="--- å°èª¿ Minor ---">
                    <option>a minor</option><option>e minor</option><option>b minor</option><option>f# minor</option>
                    <option>c# minor</option><option>g# minor</option><option>eb minor</option><option>bb minor</option>
                    <option>f minor</option><option>c minor</option><option>g minor</option><option>d minor</option>
                </optgroup>
            </select>
            <input type="number" id="scaleBpmInput" value="120" style="width: 50px;">
            <button class="btn-main" onclick="addScaleTask()">åŠ å…¥</button>
        </div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="newTaskInput" placeholder="è¼¸å…¥å…§å®¹..." style="flex: 1;">
            <button class="btn-main" onclick="addTask()">æ–°å¢</button>
        </div>
    </div>
    <ul class="task-list" id="taskList"></ul>
</div>

<div class="footer-credit">è¨­è¨ˆè€…ï¼šé™³æ¬£å®œ 2026</div>

<script>
    let audioCtx = null, metroRunning = false, nextTickTime = 0, currentBeat = 0, timerID = null, isStarLocked = true;
    let count = 5; 
    const MASTER_PWD = "888";

    let currentSaveName = localStorage.getItem('v_save_v16') || 'é è¨­å­˜æª”';
    let saveList = JSON.parse(localStorage.getItem('v_list_v16')) || ['é è¨­å­˜æª”'];
    let appData = {};

    function init() { loadData(); updateSaveSelect(); renderUI(); }

    function loadData() {
        const raw = localStorage.getItem(`v_data_v16_${currentSaveName}`);
        appData = raw ? JSON.parse(raw) : { tasks: [], stats: {}, threshold: 30, weekStart: new Date().toISOString().split('T')[0] };
        document.getElementById('starThreshold').value = appData.threshold;
        document.getElementById('weekStartDate').value = appData.weekStart;
        document.getElementById('displayName').innerText = currentSaveName;
        isStarLocked = true;
        document.getElementById('starThreshold').disabled = true;
        document.getElementById('lockBtn').innerText = "ğŸ”‘ ç®¡ç†è¨­å®š";
    }

    function saveData() {
        appData.threshold = document.getElementById('starThreshold').value;
        appData.weekStart = document.getElementById('weekStartDate').value;
        localStorage.setItem(`v_data_v16_${currentSaveName}`, JSON.stringify(appData));
        localStorage.setItem('v_list_v16', JSON.stringify(saveList));
        localStorage.setItem('v_save_v16', currentSaveName);
    }

    function renderUI() {
        const grid = document.getElementById('statsGrid'); grid.innerHTML = '';
        const start = new Date(appData.weekStart);
        const threshold = parseInt(appData.threshold) || 30;
        let weekTotal = 0;
        for (let i = 0; i < 7; i++) {
            const curr = new Date(start); curr.setDate(start.getDate() + i);
            const dStr = curr.toISOString().split('T')[0];
            const sec = appData.stats[dStr] || 0; weekTotal += sec;
            const box = document.createElement('div');
            box.className = `day-box ${dStr === new Date().toISOString().split('T')[0] ? 'today' : ''}`;
            box.innerHTML = `<div>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][curr.getDay()]}</div><b>${Math.round(sec/60)}m</b>`;
            grid.appendChild(box);
        }
        document.getElementById('weekTotalDisplay').innerText = `ç¸½è¨ˆ: ${Math.floor(weekTotal/60)} åˆ†`;
        document.getElementById('starContainer').innerHTML = 'â­'.repeat(Math.floor((weekTotal/60)/threshold)) || 'åŠ æ²¹ï¼';

        const list = document.getElementById('taskList'); list.innerHTML = '';
        appData.tasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = `task-item ${t.completed ? 'completed' : ''}`;
            li.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onclick="toggleTask(${i})">
                <span class="task-text" onclick="speak('${t.text}')" ondblclick="editTask(${i})">${t.text}</span>
                <button onclick="deleteTask(${i})" style="color:#ccc; background:none;">âœ•</button>`;
            list.appendChild(li);
        });
    }

    // --- éŸ³æ•ˆç³»çµ± ---
    function playCounterSound(isEnd = false) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const envelope = audioCtx.createGain();
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(isEnd ? 880 : 1320, audioCtx.currentTime); // çµæŸéŸ³è¼ƒä½ï¼Œéç¨‹éŸ³è¼ƒé«˜
        
        envelope.gain.setValueAtTime(0, audioCtx.currentTime);
        envelope.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01); // éŸ³é‡è¼ƒå°
        envelope.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (isEnd ? 0.3 : 0.1));
        
        osc.connect(envelope);
        envelope.connect(audioCtx.destination);
        
        osc.start();
        osc.stop(audioCtx.currentTime + (isEnd ? 0.3 : 0.1));
    }

    function handleCounterClick() {
        const setVal = parseInt(document.getElementById('customCountSet').value) || 5;
        if (count > 0) {
            count--;
            playCounterSound(count === 0); // åˆ° 0 æ™‚ç™¼å‡ºçµæŸæç¤ºéŸ³
        } else {
            count = setVal;
            playCounterSound(false);
        }
        document.getElementById('countNum').innerText = count;
        const btn = document.getElementById('countNum');
        btn.style.transform = "scale(0.9)";
        setTimeout(() => btn.style.transform = "scale(1)", 100);
    }
    
    function syncNewStartValue() {
        const setVal = parseInt(document.getElementById('customCountSet').value) || 5;
        count = setVal;
        document.getElementById('countNum').innerText = count;
    }

    function resetCount() { syncNewStartValue(); }

    // --- å…¶ä»–é‚è¼¯ä¿æŒä¸è®Š ---
    function toggleStarLock() {
        if (isStarLocked) {
            if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š") === MASTER_PWD) {
                isStarLocked = false;
                document.getElementById('starThreshold').disabled = false;
                document.getElementById('starThreshold').style.background = "white";
                document.getElementById('lockBtn').innerText = "âœ… å„²å­˜é–å®š";
            }
        } else {
            isStarLocked = true;
            document.getElementById('starThreshold').disabled = true;
            document.getElementById('starThreshold').style.background = "#eee";
            document.getElementById('lockBtn').innerText = "ğŸ”‘ ç®¡ç†è¨­å®š";
            saveData();
            renderUI();
        }
    }

    function scheduler() {
        while (nextTickTime < audioCtx.currentTime + 0.1) {
            playMetronomeTick(nextTickTime);
            const bpm = document.getElementById('bpmInput').value || 100;
            const bType = parseInt(document.getElementById('beatType').value);
            nextTickTime += 60.0 / bpm;
            if (bType > 0) currentBeat = (currentBeat + 1) % bType;
        }
        timerID = window.requestAnimationFrame(scheduler);
    }
    function playMetronomeTick(time) {
        const osc = audioCtx.createOscillator();
        const envelope = audioCtx.createGain();
        const isAccent = (currentBeat === 0 && document.getElementById('beatType').value > 0);
        const volume = document.getElementById('volSlider').value;
        osc.frequency.value = isAccent ? 1200 : 800;
        envelope.gain.setValueAtTime(isAccent ? volume * 0.8 : volume * 0.3, time);
        envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
        osc.connect(envelope); envelope.connect(audioCtx.destination);
        osc.start(time); osc.stop(time + 0.05);
        if (isAccent) {
            window.setTimeout(() => {
                const btn = document.getElementById('countNum');
                btn.classList.add('flash');
                setTimeout(() => btn.classList.remove('flash'), 100);
            }, (time - audioCtx.currentTime) * 1000);
        }
    }
    function toggleMetronome() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (metroRunning) { window.cancelAnimationFrame(timerID); metroRunning = false; document.getElementById('metroBtn').innerText = "å•Ÿå‹•"; }
        else { currentBeat = 0; nextTickTime = audioCtx.currentTime; scheduler(); metroRunning = true; document.getElementById('metroBtn').innerText = "åœæ­¢"; }
    }

    function toggleTask(i) { appData.tasks[i].completed = !appData.tasks[i].completed; saveAndRefresh(); }
    function addTask() { const v = document.getElementById('newTaskInput').value; if(v){ appData.tasks.push({text:v, completed:false}); document.getElementById('newTaskInput').value=''; saveAndRefresh(); } }
    function addScaleTask() { const k=document.getElementById('scaleKey').value, b=document.getElementById('scaleBpmInput').value; appData.tasks.push({text:`ğŸ¹ ${k} (${b} BPM)`, completed:false}); saveAndRefresh(); }
    function editTask(i) { const nt = prompt("ä¿®æ”¹ç·´ç¿’ï¼š", appData.tasks[i].text); if(nt){ appData.tasks[i].text=nt; saveAndRefresh(); } }
    function deleteTask(i) { if(confirm("ç¢ºå®šåˆªé™¤é …ç›®ï¼Ÿ")){ appData.tasks.splice(i,1); saveAndRefresh(); } }
    function saveAndRefresh() { saveData(); renderUI(); }
    function speak(t) { const m=new SpeechSynthesisUtterance(t); m.lang='zh-TW'; window.speechSynthesis.speak(m); }
    function updateSaveSelect() { const sel=document.getElementById('saveSelect'); sel.innerHTML=''; saveList.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.text=n; if(n===currentSaveName) o.selected=true; sel.add(o); }); }
    function switchSave() { currentSaveName=document.getElementById('saveSelect').value; init(); }
    function createNewSave() { const n=prompt("è¼¸å…¥æ–°æª”æ¡ˆåç¨±ï¼š"); if(n && !saveList.includes(n)){ saveList.push(n); currentSaveName=n; appData={tasks:[], stats:{}, threshold:30, weekStart:new Date().toISOString().split('T')[0]}; saveData(); init(); } }

    init();
</script>
</body>
</html>

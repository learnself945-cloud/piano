<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Vivace ç·´ç´åŠ©æ‰‹ - é™³æ¬£å®œ 2026</title>
    <style>
        :root { 
            --bg-paper: #fff9f0; --warm-wood: #8c5a44; --cream: #fdf6e3; 
            --warm-pink: #ffdae0; --caramel: #d4a373; --gold: #f1c40f; --alert: #e67e22;
            --milk-tea: #ddc1a7; --light-coffee: #a67c52;
        }
        
        body { 
            background: var(--bg-paper); 
            font-family: "PingFang TC", "Noto Sans TC", "Heiti TC", "Microsoft JhengHei", sans-serif;
            display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--warm-wood); 
        }

        .app-card { width: 100%; max-width: 600px; background: white; padding: 25px; border-radius: 30px; border: 8px solid var(--warm-pink); box-shadow: 0 10px 30px rgba(140,90,68,0.1); position: relative; }
        .file-manager { display: flex; gap: 8px; margin-bottom: 15px; background: var(--caramel); padding: 10px 20px; border-radius: 50px; color: white; align-items: center; justify-content: center; }
        .file-manager select { background: white; border-radius: 5px; padding: 3px; border: none; color: var(--warm-wood); font-weight: bold; }

        .timer-section { background: var(--cream); padding: 25px; border-radius: 25px; margin-bottom: 15px; text-align: center; border: 3px solid var(--caramel); }
        .timer-display { font-size: 64px; font-family: 'Verdana', sans-serif; font-weight: bold; color: var(--warm-wood); margin: 5px 0; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--caramel); width: 100%; transition: width 1s linear; }

        .recorder-section { background: #fff; padding: 15px; border-radius: 20px; border: 2px solid var(--warm-pink); margin-bottom: 20px; text-align: center; }
        .rec-active { color: #e74c3c; font-weight: bold; animation: blink 1s infinite; margin-bottom: 5px; display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        audio { width: 100%; margin-top: 10px; height: 35px; }

        .reward-banner { background: var(--milk-tea); color: var(--warm-wood); padding: 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #c8ab8f; }
        .star-display { font-size: 36px; color: var(--gold); margin-bottom: 5px; min-height: 45px; word-break: break-all; }
        
        .stats-section { background: rgba(255, 218, 224, 0.3); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed var(--caramel); }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-box { font-size: 11px; background: white; padding: 8px 2px; border-radius: 12px; border: 1px solid var(--warm-pink); }
        .day-box.today { background: var(--caramel); color: white; border: 1px solid var(--warm-wood); }

        .admin-section { display: none; background: var(--warm-pink); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 2px solid var(--caramel); }
        .admin-sub-card { background: white; padding: 12px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--milk-tea); }
        
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { border: 2px solid var(--warm-pink); padding: 15px; border-radius: 20px; background: white; text-align: center; }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 10px; background: white; border-radius: 12px; margin-bottom: 8px; border: 1px solid #f0e6d2; gap: 8px; }
        .task-text { flex: 1; font-size: 15px; color: var(--warm-wood); }
        .task-text.editable { cursor: pointer; text-decoration: underline dotted; }

        .teacher-note-area { margin-top: 20px; padding: 15px; background: #fffcf5; border: 2px solid var(--warm-pink); border-radius: 15px; position: relative; }
        #teacherNoteDisplay { min-height: 50px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: #555; }
        #noteEditorContainer { display: none; flex-direction: column; gap: 10px; }
        #teacherNoteEdit { width: 100%; min-height: 80px; border: 1px solid var(--caramel); border-radius: 8px; padding: 8px; font-family: inherit; box-sizing: border-box; }
        
        .speak-btn { cursor: pointer; font-size: 18px; transition: 0.2s; background: none; border: none; padding: 0 5px; }
        .speak-btn:hover { transform: scale(1.2); }

        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; padding: 8px 12px; font-family: inherit; }
        .btn-warm { background: var(--caramel); color: white; }
        .btn-soft { background: var(--warm-pink); color: var(--warm-wood); }
        .template-tag { background: #fff; border: 1px solid var(--caramel); font-size: 11px; padding: 4px 8px; border-radius: 8px; cursor: pointer; }
        .template-tag:hover { background: var(--warm-pink); }
        
        .counter-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--warm-pink); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 4px solid white; font-size: 32px; font-weight: bold; margin: 10px auto; color: var(--warm-wood); }
        #taskLockBtn { background: #eee; border: 2px solid var(--caramel); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #taskLockBtn.unlocked { background: var(--warm-pink); transform: rotate(15deg); }

        @media print {
            .file-manager, .timer-section, .recorder-section, .tools-grid, .admin-section, #weekStartDate, .btn-warm, .btn-soft, .task-item button, #taskLockBtn, input, select, textarea, .speak-btn { display: none !important; }
            .app-card { border: none; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="file-manager">
    <span>ğŸ“ å­¸ç”Ÿï¼š</span>
    <select id="saveSelect" onchange="switchSave()"></select>
    <button onclick="createNewSave()" style="background:#555; color:white; font-size:11px;">â• æ–°å¢</button>
    <button onclick="renameCurrentSave()" style="background:transparent; border:1px solid white; color:white; font-size:10px;">âœï¸ æ”¹å</button>
</div>

<div class="app-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: var(--warm-wood);" id="displayName">ğŸ“Š ç·´ç´ç´€éŒ„</h3>
        <span style="background:var(--caramel); color:white; padding:4px 12px; border-radius:15px; font-size:12px;" id="weekTotalDisplay">ç¸½è¨ˆ: 0 åˆ†</span>
    </div>

    <div class="timer-section">
        <div style="font-size: 13px; color: var(--caramel); margin-bottom: 5px;" id="currentTaskTitle">è«‹é»é¸ä¸‹æ–¹ç·´ç¿’é …ç›®</div>
        <div class="timer-display" id="mainClock">20:00</div>
        <div class="progress-container"><div class="progress-bar" id="timerBar"></div></div>
        <div style="display: flex; justify-content: center; gap: 8px; align-items: center;">
            <input type="number" id="setMinutes" value="20" min="1" style="width: 40px; text-align: center; font-family: inherit;"> åˆ†
            <button class="btn-warm" id="timerBtn" onclick="toggleTimer()">â–¶ é–‹å§‹</button>
            <button class="btn-soft" onclick="resetTimer()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <div class="reward-banner">
        <div id="starContainer" class="star-display"></div>
        <div style="font-size: 11px; opacity: 0.9;">
            â­ æ¯ <input type="number" id="starThreshold" value="30" min="1" disabled style="width: 30px; border:none; background:transparent; color:inherit; text-align:center; font-weight:bold; font-family: inherit;"> åˆ†é˜å¾—ä¸€æ˜Ÿ
            <button onclick="toggleStarLock()" id="lockBtn" style="padding: 2px 6px; font-size: 9px; background: #744b35; color: white;">ğŸ”‘ ç®¡ç†</button>
            <button onclick="resetStars()" id="resetStarBtn" class="btn-danger" style="display:none; background:#a67c52; color:white; font-size:10px;">ğŸ—‘ï¸ æ˜Ÿæ˜Ÿæ­¸é›¶</button>
        </div>
    </div>
    
    <div class="stats-section">
        <div style="text-align: center; font-size: 11px; margin-bottom: 10px; color: var(--caramel);">
            ğŸ“… æ¯é€±èµ·å§‹æ—¥ï¼š<input type="date" id="weekStartDate" onchange="saveAndRefresh()" style="font-family: inherit;">
        </div>
        <div class="stats-grid" id="statsGrid"></div>
    </div>

    <div class="recorder-section">
        <h4 style="margin: 0 0 10px 0; font-size: 15px;">ğŸ™ï¸ è‡ªæˆ‘æª¢è½éŒ„éŸ³å®¤</h4>
        <div id="recIndicator" class="rec-active">ğŸ”´ Recording...</div>
        <div style="display: flex; justify-content: center; gap: 8px;">
            <button id="startRec" class="btn-warm" onclick="startRecording()" style="background: #2ecc71;">âº éŒ„éŸ³</button>
            <button id="stopRec" class="btn-warm" onclick="stopRecording()" disabled style="background:#e74c3c; color:white;">â¹ åœæ­¢</button>
            <button id="downloadRec" class="btn-soft" onclick="downloadAudio()" style="display:none;">ğŸ’¾ ä¸‹è¼‰</button>
        </div>
        <audio id="audioPlayback" controls style="display:none;"></audio>
    </div>

    <div class="tools-grid">
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ¥ ç¯€æ‹å™¨</h4>
            <div style="font-size: 11px; margin-bottom: 5px;">
                BPM: <input type="number" id="bpmInput" value="100" style="width:40px; font-family: inherit;">
                <select id="beatType" style="width:55px; font-family: inherit;"><option value="0">ç„¡</option><option value="2">2/4</option><option value="3">3/4</option><option value="4">4/4</option><option value="6">6/8</option></select>
            </div>
            <div style="font-size: 10px; color: var(--caramel); margin-bottom: 2px;">ğŸ”Š éŸ³é‡</div>
            <input type="range" id="volSlider" style="width:100%;" min="0" max="1" step="0.1" value="0.7">
            <button class="btn-warm" onclick="toggleMetronome()" id="metroBtn" style="width:100%; margin-top:5px;">å•Ÿå‹•</button>
        </div>
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ”¢ è¨ˆæ¬¡</h4>
            <div class="counter-btn" onclick="handleCounterClick()" id="countNum">5</div>
            <input type="number" id="customCountSet" value="5" min="1" style="width: 35px; text-align: center; font-family: inherit;" oninput="syncNewStartValue()"> æ¬¡
        </div>
    </div>

    <div id="adminPanel" class="admin-section">
        <div class="admin-sub-card">
            <h4 style="margin:0 0 10px 0; color:var(--warm-wood)">âœ¨ å…§å®¹å¿«é€Ÿæ–°å¢</h4>
            <div style="background: rgba(140,90,68,0.05); padding: 10px; border-radius: 10px; margin-bottom: 12px; border: 1px dashed var(--caramel);">
                <div style="font-size: 12px; margin-bottom: 5px; font-weight: bold;">âš¡ å¿«é€Ÿæ´¾ç™¼ç¯„æœ¬ (æ›¸å+é ç¢¼)</div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="bookInput" list="bookList" placeholder="æ›¸å(å¦‚:èŠ¬è²çˆ¾)" style="flex:1; font-family: inherit;">
                    <datalist id="bookList"></datalist>
                    <input type="text" id="pageInput" placeholder="é /ç·¨è™Ÿ" style="width: 60px; font-family: inherit;">
                    <button class="btn-warm" onclick="applySmartTemplate()">æ´¾ç™¼</button>
                    <button class="btn-soft" onclick="saveAsCustomTemplate()" style="background:#f1c40f; color:white;">ğŸ’¾ å­˜ç‚ºç¯„æœ¬</button>
                </div>
                <div id="customTemplateList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="scaleKey" style="flex:1; font-family: inherit;">
                    <optgroup label="å¤§èª¿ Major"><option>C Major</option><option>G Major</option><option>D Major</option><option>A Major</option><option>E Major</option><option>B Major</option><option>F# Major</option><option>C# Major</option><option>F Major</option><option>Bb Major</option><option>Eb Major</option><option>Ab Major</option><option>Db Major</option><option>Gb Major</option><option>Cb Major</option></optgroup>
                    <optgroup label="å°èª¿ minor"><option>a minor</option><option>e minor</option><option>b minor</option><option>f# minor</option><option>c# minor</option><option>g# minor</option><option>d# minor</option><option>a# minor</option><option>d minor</option><option>g minor</option><option>c minor</option><option>f minor</option><option>bb minor</option><option>eb minor</option><option>ab minor</option></optgroup>
                </select>
                é€Ÿåº¦: <input type="number" id="scaleBpm" value="60" style="width: 40px; font-family: inherit;">
                <button class="btn-warm" onclick="addScaleTask()">åŠ éŸ³éš</button>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newTaskInput" placeholder="è‡ªè¨‚ç·´ç¿’å…§å®¹..." style="flex: 1; font-family: inherit;">
                <button class="btn-warm" onclick="addTask()">æ–°å¢</button>
            </div>
        </div>
        <div class="admin-sub-card" style="background: var(--milk-tea); border: 2px solid var(--light-coffee);">
            <h4 style="margin:0 0 10px 0; color:var(--warm-wood)">ğŸ’¾ å­˜æª”èˆ‡å‚™ä»½ç®¡ç†</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom: 10px;">
                <button onclick="exportBackupFile()" class="btn-warm" style="background: #5a8dee; font-size: 11px;">ğŸ’¾ åŒ¯å‡º (.json)</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-warm" style="background: #2ecc71; font-size: 11px;">ğŸ“‚ åŒ¯å…¥ (.json)</button>
                <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="importBackupFile(event)">
                <button onclick="exportData()" class="btn-soft" style="background: white; border: 1px solid var(--caramel); font-size: 11px;">ğŸ“¤ è¤‡è£½ä»£ç¢¼</button>
                <button onclick="importData()" class="btn-soft" style="background: white; border: 1px solid var(--caramel); font-size: 11px;">ğŸ“¥ è²¼ä¸Šä»£ç¢¼</button>
            </div>
            <button onclick="window.print()" class="btn-pdf" style="width: 100%; padding: 10px; font-size: 13px; background: #5a8dee; color: white;">ğŸ–¨ï¸ ç”¢ç”Ÿ PDF è¯çµ¡ç°¿</button>
        </div>
    </div>

    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <h3 style="color: var(--warm-wood); border-left: 5px solid var(--caramel); padding-left: 10px; margin: 0;">ğŸ“… æ¯æ—¥ç·´ç¿’é …ç›®</h3>
            <button onclick="resetChecks()" title="é‡ç½®æ‰€æœ‰å‹¾é¸" style="background:none; color:var(--caramel); padding:0; font-size:18px;">ğŸ”„</button>
        </div>
        <div id="taskLockBtn" onclick="toggleTaskLock()">ğŸ”’</div>
    </div>
    <ul class="task-list" id="taskList"></ul>

    <div class="teacher-note-area">
        <h4 style="margin: 0 0 10px 0; color: var(--warm-wood); font-size: 16px; border-left: 5px solid var(--caramel); padding-left: 10px; display: flex; align-items: center;">
            ğŸ“ æœ¬é€±è©•åƒ¹åŠæ³¨æ„äº‹é …
            <button class="speak-btn" onclick="speakNote()" title="æœ—è®€è©•åƒ¹">ğŸ“¢</button>
        </h4>
        <div id="teacherNoteDisplay"></div>
        <div id="noteEditorContainer">
            <div style="display:flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                <div style="font-size: 11px;">å¿«é€Ÿè©•èªï¼š<select id="quickNotes" onchange="addQuickNote()" style="width: 100px; font-family: inherit;"></select></div>
                <button onclick="addNewQuickNote()" style="font-size: 10px; background: #8c5a44; color: white;">â• æ–°å¢ç¯„æœ¬</button>
            </div>
            <textarea id="teacherNoteEdit" placeholder="åœ¨æ­¤è¼¸å…¥è©•åƒ¹..." style="font-family: inherit;"></textarea>
        </div>
    </div>
</div>

<div style="margin-top: 25px; font-size: 14px; color: var(--caramel); font-weight: bold;">è¨­è¨ˆè€…ï¼šé™³æ¬£å®œ 2026</div>

<script>
    /* æ ¸å¿ƒè®Šæ•¸ */
    let mediaRecorder, audioChunks = [], audioBlob, audioUrl, mediaStream = null;
    let audioCtx = null, metroRunning = false, nextTickTime = 0, currentBeat = 0, timerID = null;
    let timerInterval = null, timeLeft = 1200, totalTimeSet = 1200, isTimerRunning = false, isStarLocked = true, isTaskLocked = true;
    let count = 5;
    const MASTER_PWD = "888";
    const DEFAULT_BOOKS = ["å“ˆè¾²", "èŠ¬è²çˆ¾", "å½ˆå”±æ›²é›†", "ä½ˆçˆ¾æ ¼å½Œå‹’", "è¦–å¥"];
    const DEFAULT_NOTES = [
        { label: "âœ¨ è¡¨ç¾å„ªç•°", content: "æœ¬é€±è¡¨ç¾éå¸¸ä¸éŒ¯ï¼Œç¯€å¥å’Œæµæš¢åº¦éƒ½æœ‰é€²æ­¥ï¼Œè«‹ç¹¼çºŒä¿æŒï¼" },
        { label: "ğŸ¹ æ³¨æ„æ‰‹å‹", content: "ç·´ç¿’æ™‚è«‹æ³¨æ„æ‰‹å‹ï¼Œæ”¯æ’å¥½æŒé—œç¯€ï¼Œé¿å…æ‰‹æŒ‡å¡Œé™·ã€‚" },
        { label: "ğŸ‘‚ è½åŠ›åŠ å¼·", content: "å½ˆå¥æ™‚å¤šè½è‡ªå·±çš„è²éŸ³ï¼Œæ³¨æ„å¼·å¼±å°æ¯”èˆ‡æ¨‚å¥çš„æµæš¢åº¦ã€‚" },
        { label: "â±ï¸ æ…¢é€Ÿç·´ç¿’", content: "æ–°æ›²å­è«‹å‹™å¿…å…ˆæ…¢é€Ÿç·´ç¿’ï¼Œå¾…æŒ‡æ³•ç†Ÿç·´å¾Œå†é€æ­¥åŠ å¿«é€Ÿåº¦ã€‚" },
        { label: "âœ… å®Œæˆç›®æ¨™", content: "æ­å–œå®Œæˆæœ¬é€±ç›®æ¨™ï¼ä¸‹é€±æˆ‘å€‘å°‡æŒ‘æˆ°æ–°çš„é€²åº¦ã€‚" }
        { label: â€œæé†’ç¹³è²»", content: "ä¸‹é€±ç‚ºç¬¬ä¸€å ‚èª²ï¼Œè«‹æŠ½ç©ºç¹³è²»" }
    ];

    let currentSaveName = localStorage.getItem('v_save_v2026') || 'é è¨­å­˜æª”';
    let saveList = JSON.parse(localStorage.getItem('v_list_v2026')) || ['é è¨­å­˜æª”'];
    let appData = {};

    // ç”¨æ–¼è¨˜éŒ„æ¯å€‹ç·´ç¿’é …ç›®çš„å‹¾é¸ç‹€æ…‹ï¼ˆå­˜æª”ç”¨ï¼‰
    // é›–ç„¶ renderUI æœƒæŠ“ç•«é¢çš„ç‹€æ…‹ï¼Œä½†ä¸»è³‡æ–™çµæ§‹ä¹Ÿè¦æ”¯æ´
    function init() { loadData(); updateSaveSelect(); updateBookDatalist(); updateNoteSelect(); renderCustomTemplateButtons(); renderUI(); resetTimer(); }

    // --- âœ¨ èªéŸ³åˆ‡æ›é–‹é—œä¿®æ­£ ---
    function toggleSpeech(text) {
        if (!text) return;
        // å¦‚æœæ­£åœ¨æœ—è®€ä¸­ï¼Œå†æŒ‰ä¸€ä¸‹å°±åœæ­¢
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        } else {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }
    }

    function speakNote() {
        toggleSpeech(appData.teacherNote || "ç›®å‰æ²’æœ‰è©•åƒ¹å…§å®¹å¯ä»¥æœ—è®€å–”ï¼");
    }

    // --- âœ¨ é‡ç½®å‹¾é¸åŠŸèƒ½ ---
    function resetChecks() {
        if (confirm("è¦æ¸…é™¤æ‰€æœ‰é …ç›®çš„å‹¾é¸ç‹€æ…‹å—ï¼Ÿ")) {
            const list = document.getElementById('taskList');
            list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // åŒæ™‚æ›´æ–°å­˜æª”è³‡æ–™ï¼ˆå¦‚æœæœ‰å­˜çš„è©±ï¼‰
            if(appData.tasks) appData.tasks.forEach(t => t.done = false);
            saveData();
        }
    }

    // --- è‡ªè¨‚æ¨¡æ¿åŠŸèƒ½ ---
    function saveAsCustomTemplate() {
        const book = document.getElementById('bookInput').value;
        const page = document.getElementById('pageInput').value;
        const content = book + (page ? " " + page : "");
        if (!book) { alert("è«‹å…ˆè¼¸å…¥æ›¸åï¼"); return; }
        
        const name = prompt("è«‹ç‚ºæ­¤ç¯„æœ¬å‘½åï¼š", book);
        if (name) {
            let templates = JSON.parse(localStorage.getItem('v_custom_templates')) || {};
            templates[name] = content;
            localStorage.setItem('v_custom_templates', JSON.stringify(templates));
            renderCustomTemplateButtons();
        }
    }

    function renderCustomTemplateButtons() {
        const container = document.getElementById('customTemplateList');
        const templates = JSON.parse(localStorage.getItem('v_custom_templates')) || {};
        container.innerHTML = "";
        Object.keys(templates).forEach(name => {
            const btn = document.createElement('button');
            btn.className = "template-tag";
            btn.innerText = name;
            btn.onclick = () => { document.getElementById('bookInput').value = templates[name]; };
            btn.oncontextmenu = (e) => {
                e.preventDefault();
                if (confirm("åˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ")) {
                    delete templates[name];
                    localStorage.setItem('v_custom_templates', JSON.stringify(templates));
                    renderCustomTemplateButtons();
                }
            };
            container.appendChild(btn);
        });
    }

    function loadData() {
        const raw = localStorage.getItem(`v_data_v2026_${currentSaveName}`);
        appData = raw ? JSON.parse(raw) : { tasks: [], stats: {}, threshold: 30, weekStart: new Date().toISOString().split('T')[0], baseMinutes: 0, teacherNote: "" };
        // ç¢ºä¿ task çµæ§‹åŒ…å« done å±¬æ€§
        if(appData.tasks) appData.tasks.forEach(t => { if(t.done === undefined) t.done = false; });
        
        document.getElementById('starThreshold').value = appData.threshold || 30;
        document.getElementById('weekStartDate').value = appData.weekStart;
        document.getElementById('displayName').innerText = currentSaveName;
        document.getElementById('teacherNoteEdit').value = appData.teacherNote || "";
        syncNewStartValue();
    }

    function saveData() { 
        // å„²å­˜å‰æ›´æ–°å‹¾é¸ç‹€æ…‹åˆ°è³‡æ–™ç‰©ä»¶
        const list = document.getElementById('taskList');
        const checkBoxes = list.querySelectorAll('input[type="checkbox"]');
        checkBoxes.forEach((cb, idx) => {
            if(appData.tasks[idx]) appData.tasks[idx].done = cb.checked;
        });

        appData.threshold = document.getElementById('starThreshold').value;
        appData.weekStart = document.getElementById('weekStartDate').value;
        appData.teacherNote = document.getElementById('teacherNoteEdit').value;
        localStorage.setItem(`v_data_v2026_${currentSaveName}`, JSON.stringify(appData));
        localStorage.setItem('v_list_v2026', JSON.stringify(saveList));
        localStorage.setItem('v_save_v2026', currentSaveName);
    }

    function saveAndRefresh() { saveData(); renderUI(); }

    function renderUI() {
        const grid = document.getElementById('statsGrid'); grid.innerHTML = '';
        const start = new Date(appData.weekStart);
        let weekTotal = 0;
        for (let i = 0; i < 7; i++) {
            const curr = new Date(start); curr.setDate(start.getDate() + i);
            const dStr = curr.toISOString().split('T')[0];
            const sec = appData.stats[dStr] || 0; weekTotal += sec;
            const box = document.createElement('div');
            box.className = `day-box ${dStr === new Date().toISOString().split('T')[0] ? 'today' : ''}`;
            box.innerHTML = `<div>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][curr.getDay()]}</div><b>${Math.round(sec/60)}m</b>`;
            grid.appendChild(box);
        }
        document.getElementById('weekTotalDisplay').innerText = `ç¸½è¨ˆ: ${Math.floor(weekTotal/60)} åˆ†`;
        const stars = Math.floor(Math.max(0, Math.floor(weekTotal/60) - (appData.baseMinutes || 0)) / (parseInt(appData.threshold) || 30));
        document.getElementById('starContainer').innerHTML = 'â­'.repeat(stars) || 'âœ¨';
        
        const taskListEl = document.getElementById('taskList');
        taskListEl.innerHTML = '';
        appData.tasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = `task-item`;
            const deleteBtn = isTaskLocked ? '' : `<button onclick="deleteTask(${i})" style="color:#e74c3c; background:none; margin-left:auto;">âœ•</button>`;
            
            li.innerHTML = `
                <input type="checkbox" ${t.done ? 'checked' : ''} onchange="saveData()">
                <span class="${isTaskLocked ? 'task-text' : 'task-text editable'}" ${isTaskLocked ? `onclick="selectTask('${t.text}')"` : `onclick="handleTaskEdit(${i})"`}>${t.text}</span>
                <button class="speak-btn" onclick="toggleSpeech('${t.text}')">ğŸ”Š</button>
                ${deleteBtn}`;
            taskListEl.appendChild(li);
        });
        document.getElementById('teacherNoteDisplay').innerText = appData.teacherNote || "";
    }

    // --- ä»¥ä¸‹ç‚ºåŸæœ‰é‚è¼¯ (è¨ˆæ™‚ã€éŒ„éŸ³ã€å¯†ç¢¼ã€ç¯€æ‹å™¨ç­‰) ä¿æŒä¸è®Š ---
    function toggleStarLock() {
        if (isStarLocked) {
            if (prompt("å¯†ç¢¼ï¼š") === MASTER_PWD) {
                isStarLocked = false;
                document.getElementById('starThreshold').disabled = false;
                document.getElementById('resetStarBtn').style.display = "inline-block";
                document.getElementById('teacherNoteDisplay').style.display = "none";
                document.getElementById('noteEditorContainer').style.display = "flex";
            }
        } else {
            isStarLocked = true;
            document.getElementById('starThreshold').disabled = true;
            document.getElementById('resetStarBtn').style.display = "none";
            document.getElementById('teacherNoteDisplay').style.display = "block";
            document.getElementById('noteEditorContainer').style.display = "none";
            saveAndRefresh();
        }
    }
    function toggleTaskLock() {
        isTaskLocked = !isTaskLocked;
        const btn = document.getElementById('taskLockBtn');
        const panel = document.getElementById('adminPanel');
        if (isTaskLocked) { btn.innerText = "ğŸ”’"; btn.classList.remove('unlocked'); panel.style.display = 'none'; } 
        else { btn.innerText = "ğŸ”“"; btn.classList.add('unlocked'); panel.style.display = 'block'; }
        renderUI();
    }
    function selectTask(text) { document.getElementById('currentTaskTitle').innerText = "æ­£åœ¨ç·´ç¿’ï¼š" + text; }
    function handleTaskEdit(i) { const n = prompt("ç·¨è¼¯é …ç›®ï¼š", appData.tasks[i].text); if (n) { appData.tasks[i].text = n; saveAndRefresh(); } }
    function syncNewStartValue() { count = parseInt(document.getElementById('customCountSet').value) || 5; document.getElementById('countNum').innerText = count; }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; document.getElementById('timerBtn').innerText = "â–¶ é–‹å§‹"; timeLeft = (parseInt(document.getElementById('setMinutes').value) || 20) * 60; totalTimeSet = timeLeft; updateClockDisplay(); document.getElementById('timerBar').style.width = "100%"; }
    function toggleTimer() { 
        if (!isTimerRunning) { 
            isTimerRunning = true; document.getElementById('timerBtn').innerText = "â¸ æš«åœ"; 
            timerInterval = setInterval(() => { 
                timeLeft--; updateClockDisplay(); 
                document.getElementById('timerBar').style.width = (timeLeft/totalTimeSet)*100 + "%"; 
                if (timeLeft <= 0) { clearInterval(timerInterval); saveTimeProgress(); alert("æ™‚é–“åˆ°ï¼"); resetTimer(); } 
            }, 1000); 
        } else { isTimerRunning = false; document.getElementById('timerBtn').innerText = "â–¶ ç¹¼çºŒ"; clearInterval(timerInterval); } 
    }
    function updateClockDisplay() { const m = Math.floor(timeLeft / 60).toString().padStart(2, '0'); const s = (timeLeft % 60).toString().padStart(2, '0'); document.getElementById('mainClock').innerText = `${m}:${s}`; }
    function saveTimeProgress() { const today = new Date().toISOString().split('T')[0]; appData.stats[today] = (appData.stats[today] || 0) + totalTimeSet; saveAndRefresh(); }
    function applySmartTemplate() { const b = document.getElementById('bookInput').value; const p = document.getElementById('pageInput').value; if (!b) return; appData.tasks.push({ text: b + (p ? " " + p : ""), done: false }); saveAndRefresh(); }
    function addScaleTask() { appData.tasks.push({text: `ğŸ¹ éŸ³éšï¼š${document.getElementById('scaleKey').value} (${document.getElementById('scaleBpm').value} BPM)`, done: false}); saveAndRefresh(); }
    function addTask() { const v = document.getElementById('newTaskInput').value; if(v){ appData.tasks.push({text:v, done: false}); document.getElementById('newTaskInput').value=''; saveAndRefresh(); } }
    function deleteTask(i) { appData.tasks.splice(i,1); saveAndRefresh(); }
    function handleCounterClick() { 
        const startVal = parseInt(document.getElementById('customCountSet').value) || 5; 
        if (count > 1) { count--; playBeep(1000, 0.1); document.getElementById('countNum').innerText = count; } 
        else { count = 0; document.getElementById('countNum').innerText = 0; playBeep(1600, 0.4); setTimeout(() => { count = startVal; document.getElementById('countNum').innerText = count; }, 500); } 
    }
    function toggleMetronome() { 
        if (!audioCtx) audioCtx = new AudioContext(); 
        if (metroRunning) { window.cancelAnimationFrame(timerID); metroRunning = false; document.getElementById('metroBtn').innerText = "å•Ÿå‹•"; } 
        else { nextTickTime = audioCtx.currentTime; currentBeat = 0; scheduler(); metroRunning = true; document.getElementById('metroBtn').innerText = "åœæ­¢"; } 
    }
    function scheduler() { 
        const bpm = document.getElementById('bpmInput').value;
        const beatType = parseInt(document.getElementById('beatType').value);
        while (nextTickTime < audioCtx.currentTime + 0.1) { 
            let freq = (beatType > 0 && currentBeat === 0) ? 1200 : 800; 
            playBeep(freq, 0.05); 
            nextTickTime += 60 / bpm; 
            currentBeat = beatType > 0 ? (currentBeat + 1) % beatType : 0;
        } 
        timerID = window.requestAnimationFrame(scheduler); 
    }
    function playBeep(f, d) { 
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); 
        const vol = document.getElementById('volSlider') ? parseFloat(document.getElementById('volSlider').value) : 0.7;
        o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(vol * 0.2, audioCtx.currentTime); 
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d); 
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d); 
    }
    function switchSave() { currentSaveName=document.getElementById('saveSelect').value; init(); }
    function updateSaveSelect() {
        const s = document.getElementById('saveSelect'); s.innerHTML='';
        saveList.forEach(n=>{
            const o=document.createElement('option'); o.value=n; o.text=n;
            if(n===currentSaveName) o.selected=true;
            s.add(o);
        });
    }
    function createNewSave() {
        const n=prompt("è¼¸å…¥æ–°å­¸ç”Ÿåç¨±ï¼š");
        if(n && !saveList.includes(n)){
            saveList.push(n); currentSaveName=n;
            appData={tasks:[], stats:{}, threshold:30, weekStart:new Date().toISOString().split('T')[0], baseMinutes:0, teacherNote: ""};
            saveAndRefresh(); updateSaveSelect();
        }
    }
    function renameCurrentSave() {
        const n = prompt("å°‡ã€Œ" + currentSaveName + "ã€æ›´åç‚ºï¼š", currentSaveName);
        if (n && n !== currentSaveName) {
            const oldKey = `v_data_v2026_${currentSaveName}`;
            saveList = saveList.map(name => name === currentSaveName ? n : name);
            currentSaveName = n;
            saveData(); localStorage.removeItem(oldKey);
            init();
        }
    }
    async function startRecording() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            let mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
            mediaRecorder = new MediaRecorder(mediaStream, { mimeType });
            audioChunks = [];
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: mimeType });
                audioUrl = URL.createObjectURL(audioBlob);
                const pb = document.getElementById('audioPlayback'); pb.src = audioUrl; pb.style.display = 'block';
                document.getElementById('downloadRec').style.display = 'inline-block';
            };
            mediaRecorder.start();
            document.getElementById('startRec').disabled = true; document.getElementById('stopRec').disabled = false;
            document.getElementById('recIndicator').style.display = 'block';
        } catch (err) { alert("éŒ„éŸ³å¤±æ•—"); }
    }
    function stopRecording() { 
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); 
        if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
        document.getElementById('startRec').disabled = false; document.getElementById('stopRec').disabled = true;
        document.getElementById('recIndicator').style.display = 'none'; 
    }
    function downloadAudio() { const a = document.createElement('a'); a.href = audioUrl; a.download = `éŒ„éŸ³_${new Date().getTime()}.webm`; a.click(); }
    function updateBookDatalist() { const dl = document.getElementById('bookList'); dl.innerHTML = ""; DEFAULT_BOOKS.forEach(name => { const opt = document.createElement('option'); opt.value = name; dl.appendChild(opt); }); }
    function updateNoteSelect() {
        const sel = document.getElementById('quickNotes');
        sel.innerHTML = '<option value="">-- é¸æ“‡ç¯„æœ¬ --</option>';
        DEFAULT_NOTES.forEach(item => { const opt = document.createElement('option'); opt.value = item.content; opt.text = item.label; sel.appendChild(opt); });
    }
    function addQuickNote() {
        const sel = document.getElementById('quickNotes');
        if (sel.value) {
            const editor = document.getElementById('teacherNoteEdit');
            editor.value += (editor.value ? "\n" : "") + sel.value;
            sel.value = "";
        }
    }
    function addNewQuickNote() { const c = prompt("è©•èªå…§å®¹ï¼š"); if(c){ const l = prompt("ç°¡ç¨±ï¼š", c.substring(0,4)); DEFAULT_NOTES.push({label:l, content:c}); updateNoteSelect(); } }
    function exportBackupFile() {
        const today = new Date().toISOString().split('T')[0];
        const defaultFileName = `${currentSaveName}_backup_${today}`;
        const customName = prompt("è«‹è¼¸å…¥åŒ¯å‡ºçš„æª”æ¡ˆåç¨±ï¼š", defaultFileName);
        if (customName === null) return;
        const finalFileName = (customName.trim() || defaultFileName) + ".json";
        const backupData = { studentName: currentSaveName, content: appData, exportDate: today };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = finalFileName; a.click();
    }
    function importBackupFile(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { 
            try { 
                const data = JSON.parse(e.target.result); 
                if (confirm(`è¼‰å…¥ã€Œ${data.studentName}ã€ï¼Ÿ`)) { appData = data.content; saveAndRefresh(); } 
            } catch (err) { alert("æ ¼å¼éŒ¯èª¤"); } event.target.value = ""; 
        };
        reader.readAsText(file);
    }
    function exportData() { const obj = { tasks: appData.tasks, teacherNote: appData.teacherNote }; const code = btoa(encodeURIComponent(JSON.stringify(obj))); navigator.clipboard.writeText(code).then(() => alert("ä»£ç¢¼å·²è¤‡è£½")); }
    function importData() { const code = prompt("è²¼ä¸Šä»£ç¢¼ï¼š"); if (!code) return; try { const data = JSON.parse(decodeURIComponent(atob(code))); appData.tasks = data.tasks; appData.teacherNote = data.teacherNote; saveAndRefresh(); } catch (e) { alert("ç„¡æ•ˆä»£ç¢¼"); } }
    function resetStars() { if (confirm("ç¢ºå®šæ˜Ÿæ˜Ÿæ­¸é›¶å—ï¼Ÿ")) { let totalSec = 0; Object.values(appData.stats).forEach(s => totalSec += s); appData.baseMinutes = Math.floor(totalSec / 60); saveAndRefresh(); } }

    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Vivace ç·´ç´åŠ©æ‰‹ - ç·¨è¼¯å¼·åŒ–ç‰ˆ</title>
    <style>
        :root { 
            --bg-paper: #fdf6e3; --piano-black: #2c3e50; --soft-pink: #ffdae0; 
            --mint: #b8e994; --gold: #d4a373; --wood: #8c5a44; --star-color: #f1c40f;
        }
        body { background: var(--bg-paper); font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--piano-black); overflow-x: hidden; }
        .app-card { width: 100%; max-width: 600px; background: #fffaf0; padding: 30px; border-radius: 30px; border: 8px solid var(--soft-pink); box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        
        /* çµ±è¨ˆèˆ‡çå‹µå€ */
        .stats-section { background: rgba(255, 218, 224, 0.3); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed var(--gold); }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-bottom: 10px; }
        .day-box { font-size: 11px; background: white; padding: 8px 2px; border-radius: 12px; border: 1px solid var(--soft-pink); transition: 0.3s; }
        .day-box.today { background: var(--mint); border: 2px solid var(--wood); transform: scale(1.05); }
        .week-config { font-size: 12px; text-align: center; margin-bottom: 10px; color: var(--wood); font-weight: bold; }
        
        .reward-banner { background: var(--piano-black); color: white; padding: 12px; border-radius: 15px; text-align: center; }
        .star-display { font-size: 24px; color: var(--star-color); margin-top: 5px; min-height: 30px; }

        /* è¨ˆæ™‚å™¨å€ */
        .timer-section { text-align: center; background: var(--piano-black); color: #fff; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .timer-display { font-size: 50px; font-weight: bold; font-family: monospace; color: var(--mint); }
        .timer-input-group { margin-top: 10px; font-size: 14px; color: #ccc; }
        .timer-input-group input { width: 45px; background: #444; border: 1px solid var(--mint); color: white; text-align: center; border-radius: 5px; padding: 3px; }

        /* å·¥å…·å€ */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { border: 2px solid var(--soft-pink); padding: 15px; border-radius: 20px; background: white; text-align: center; }
        
        button { cursor: pointer; border: none; border-radius: 12px; padding: 10px 15px; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-main { background: var(--wood); color: white; }
        .btn-mint { background: var(--mint); color: var(--wood); }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 15px; margin-bottom: 8px; border: 1px solid #eee; gap: 10px; transition: 0.2s; }
        .task-text { flex: 1; font-size: 16px; cursor: pointer; }
        .task-text:hover { color: var(--gold); text-decoration: underline; }
        .completed { background: #f0f0f0; opacity: 0.7; }
        .completed .task-text { text-decoration: line-through; color: #aaa; }

        input, select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        #fireworksCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
    </style>
</head>
<body>

<div class="app-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: var(--wood);">ğŸ“Š æœ¬é€±ç·´ç´ç´€éŒ„</h3>
        <span style="background:var(--wood); color:white; padding:4px 12px; border-radius:15px; font-size:12px;" id="weekTotalDisplay">ç¸½è¨ˆ: 0 åˆ†é˜</span>
    </div>
    
    <div class="stats-section">
        <div class="week-config">ğŸ“… æœ¬é€±èµ·å§‹ï¼š<input type="date" id="weekStartDate" onchange="updateStatsAndStars()"></div>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="reward-banner">
            <div style="font-size: 13px;">ğŸ† çå‹µ (æ¯ 30 åˆ†é˜ â­)</div>
            <div id="starContainer" class="star-display"></div>
            <div id="nextStarInfo" style="font-size: 10px; color: #aaa;"></div>
        </div>
    </div>

    <div class="timer-section">
        <div class="timer-display" id="timeShow">25:00</div>
        <div class="timer-input-group">è¨­å®šï¼š<input type="number" id="customTimeInput" value="25" oninput="updateTimeFromInput()"> åˆ†é˜</div>
        <button class="btn-mint" onclick="toggleTimer()" id="timerBtn" style="margin-top:15px">é–‹å§‹ç·´ç¿’</button>
        <button onclick="resetTimer()" style="background:transparent; color:white; border:1px solid white; font-size:12px; margin-left: 10px;">é‡è¨­</button>
    </div>

    <div class="tools-grid">
        <div class="tool-box">
            <h4 style="margin:0">ğŸ¥ ç¯€æ‹å™¨</h4>
            <div style="font-size:11px; margin:5px 0;">BPM: <input type="number" id="bpmInput" value="100" style="width:40px;"></div>
            <select id="soundType" style="font-size:11px; width:100%; margin-bottom:5px;">
                <option value="click">æ‰“é»æ¿</option><option value="sticks">é¼“æ£’</option><option value="sharp">é›»å­éŸ³</option>
            </select>
            <input type="range" id="volInput" min="0" max="2" step="0.1" value="1.5" style="width:100%;">
            <button class="btn-main" onclick="toggleMetronome()" id="metroBtn" style="width:100%; margin-top:5px;">å•Ÿå‹•</button>
        </div>
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ”¢ è¨ˆæ¬¡</h4>
            <div onclick="changeCount(-1)" style="width:50px; height:50px; border-radius:50%; background:var(--soft-pink); margin:0 auto; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid white; font-weight:bold;" id="countNum">5</div>
            <button onclick="resetCount()" style="background:none; text-decoration:underline; font-size:11px; margin-top:10px; color: var(--wood);">é‡ç½®</button>
        </div>
    </div>

    <div style="background: var(--soft-pink); padding: 15px; border-radius: 20px; margin-bottom: 20px;">
        <h4 style="margin:0 0 10px 0">âœ¨ æ–°å¢ç·´ç¿’ (é›™æ“Šæ–‡å­—å¯ç·¨è¼¯)</h4>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <select id="scaleKey" style="flex:1"><option>C Major</option><option>G Major</option><option>D Major</option><option>A Major</option><option>E Major</option><option>F Major</option><option>Bb Major</option><option>a minor</option><option>e minor</option><option>d minor</option></select>
            <input type="number" id="scaleBpmInput" value="120" style="width: 50px;">
            <button class="btn-main" onclick="addScaleTask()">åŠ å…¥</button>
        </div>
        <div style="display: flex; gap: 5px;"><input type="text" id="newTaskInput" placeholder="æ›²ç›®åç¨±..." style="flex: 1;"><button class="btn-main" onclick="addTask()">æ–°å¢</button></div>
    </div>

    <ul class="task-list" id="taskList"></ul>
    <button style="background:#555; color:white; width:100%; margin-top:20px; height:45px;" onclick="printList()">ğŸ“„ åˆ—å° / å¦å­˜ PDF</button>
</div>

<canvas id="fireworksCanvas"></canvas>

<script>
    let audioCtx = null, timeLeft = 1500, timerRunning = false, timerInterval = null, metroRunning = false, metroInterval = null, count = 5;
    let savedTasks = JSON.parse(localStorage.getItem('v_tasks_v2')) || [];
    let weeklyData = JSON.parse(localStorage.getItem('v_stats_v2')) || {};
    let lastStarCount = 0;

    // è¨­å®šé è¨­é€±èµ·å§‹æ—¥ï¼ˆæœ¬é€±æ—¥ï¼‰
    const d = new Date(); d.setDate(d.getDate() - d.getDay());
    document.getElementById('weekStartDate').value = d.toISOString().split('T')[0];

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }

    function playSound(type) {
        initAudio();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain(), vol = document.getElementById('volInput').value;
        if (type === 'sticks') { o.type = 'triangle'; o.frequency.setValueAtTime(900, audioCtx.currentTime); g.gain.setValueAtTime(vol*1.5, audioCtx.currentTime); }
        else if (type === 'sharp') { o.type = 'square'; o.frequency.setValueAtTime(1200, audioCtx.currentTime); g.gain.setValueAtTime(vol*0.6, audioCtx.currentTime); }
        else { o.frequency.setValueAtTime(1800, audioCtx.currentTime); g.gain.setValueAtTime(vol, audioCtx.currentTime); }
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.15);
    }

    function updateTimeFromInput() { if (!timerRunning) { timeLeft = (document.getElementById('customTimeInput').value || 1) * 60; updateTimerUI(); } }
    function updateTimerUI() { const m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timeShow').innerText = `${m}:${s.toString().padStart(2,'0')}`; }
    function resetTimer() { timerRunning = false; clearInterval(timerInterval); document.getElementById('timerBtn').innerText = "é–‹å§‹ç·´ç¿’"; document.getElementById('customTimeInput').disabled = false; updateTimeFromInput(); }

    function toggleTimer() {
        initAudio();
        if (timerRunning) { clearInterval(timerInterval); timerRunning = false; document.getElementById('timerBtn').innerText = "ç¹¼çºŒ"; }
        else {
            timerRunning = true; document.getElementById('timerBtn').innerText = "æš«åœ";
            document.getElementById('customTimeInput').disabled = true;
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--; updateTimerUI();
                    const t = new Date().toISOString().split('T')[0];
                    weeklyData[t] = (weeklyData[t] || 0) + 1;
                    localStorage.setItem('v_stats_v2', JSON.stringify(weeklyData));
                    if (timeLeft % 10 === 0) updateStatsAndStars();
                } else { clearInterval(timerInterval); alert("ç·´ç¿’é”æˆï¼"); resetTimer(); }
            }, 1000);
        }
    }

    function updateStatsAndStars() {
        const grid = document.getElementById('statsGrid'); grid.innerHTML = '';
        const start = new Date(document.getElementById('weekStartDate').value);
        let weekSec = 0;
        const todayStr = new Date().toISOString().split('T')[0];

        for (let i = 0; i < 7; i++) {
            const curr = new Date(start); curr.setDate(start.getDate() + i);
            const dStr = curr.toISOString().split('T')[0];
            const sec = weeklyData[dStr] || 0; weekSec += sec;
            const box = document.createElement('div');
            box.className = `day-box ${dStr === todayStr ? 'today' : ''}`;
            box.innerHTML = `<div>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][curr.getDay()]}</div><div style="font-size:8px">${curr.getMonth()+1}/${curr.getDate()}</div><b>${Math.round(sec/60)}m</b>`;
            grid.appendChild(box);
        }
        const totalM = Math.floor(weekSec / 60);
        document.getElementById('weekTotalDisplay').innerText = `ç¸½è¨ˆ: ${totalM} åˆ†é˜`;
        const stars = Math.floor(totalM / 30);
        document.getElementById('starContainer').innerHTML = stars > 0 ? 'â­'.repeat(stars) : 'å°šæœªç²å¾—æ˜Ÿæ˜Ÿ';
        document.getElementById('nextStarInfo').innerText = `å†ç·´ç¿’ ${30 - (totalM % 30)} åˆ†é˜ç²å¾—ä¸‹ä¸€é¡†æ˜Ÿ`;
        if (stars > lastStarCount && lastStarCount !== 0) triggerFireworks();
        lastStarCount = stars;
    }

    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        savedTasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = `task-item ${t.completed ? 'completed' : ''}`;
            li.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onclick="toggleTask(${i})">
                <span class="task-text" ondblclick="editTask(${i})">${t.text}</span>
                <button onclick="deleteTask(${i})" style="background:none; color:#ccc;">âœ•</button>`;
            list.appendChild(li);
        });
        localStorage.setItem('v_tasks_v2', JSON.stringify(savedTasks));
    }

    function editTask(i) {
        const newText = prompt("ç·¨è¼¯ç·´ç¿’å…§å®¹ï¼š", savedTasks[i].text);
        if (newText !== null && newText.trim() !== "") {
            savedTasks[i].text = newText;
            renderTasks();
        }
    }

    function addTask() { const v = document.getElementById('newTaskInput').value; if(v) { savedTasks.push({text: v, completed: false}); document.getElementById('newTaskInput').value=''; renderTasks(); } }
    function addScaleTask() { const k = document.getElementById('scaleKey').value, b = document.getElementById('scaleBpmInput').value; savedTasks.push({text: `ğŸ¹ éŸ³éš: ${k} (${b} BPM)`, completed: false}); renderTasks(); }
    function toggleTask(i) { savedTasks[i].completed = !savedTasks[i].completed; renderTasks(); }
    function deleteTask(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { savedTasks.splice(i, 1); renderTasks(); } }

    function toggleMetronome() {
        initAudio();
        if (metroRunning) { clearTimeout(metroInterval); metroRunning = false; document.getElementById('metroBtn').innerText = "å•Ÿå‹•"; }
        else {
            metroRunning = true; document.getElementById('metroBtn').innerText = "åœæ­¢";
            const trig = () => { if(!metroRunning) return; playSound(document.getElementById('soundType').value); metroInterval = setTimeout(trig, 60000/document.getElementById('bpmInput').value); };
            trig();
        }
    }

    function changeCount(v) { initAudio(); count = Math.max(0, count + v); document.getElementById('countNum').innerText = count; if(v < 0) playSound('sharp'); }
    function resetCount() { count = 5; document.getElementById('countNum').innerText = count; }

    function printList() {
        const win = window.open('', '_blank');
        const startStr = document.getElementById('weekStartDate').value;
        let items = ''; savedTasks.forEach(t => items += `<div style="padding:15px; border-bottom:1px solid #eee; font-size:20px;">${t.completed ? 'â˜‘ï¸' : 'â˜'} ${t.text}</div>`);
        win.document.write(`<html><body style="font-family:sans-serif; padding:40px;"><h1 style="text-align:center;">ğŸ¹ ç·´ç´æ¸…å–®</h1><p style="text-align:right;">èµ·å§‹ï¼š${startStr}</p>${items}</body></html>`);
        win.document.close(); win.print();
    }

    // ç…™ç«
    const canvas = document.getElementById('fireworksCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function triggerFireworks() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; canvas.style.opacity = 1;
        for(let i=0; i<6; i++) setTimeout(() => {
            const x = Math.random()*canvas.width, y = Math.random()*(canvas.height/2), color = `hsl(${Math.random()*360},100%,50%)`;
            for(let j=0; j<40; j++) particles.push({x, y, dx:(Math.random()-0.5)*10, dy:(Math.random()-0.5)*10, alpha:1, color});
        }, i*150);
        const ani = () => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach((p,i) => { p.x += p.dx; p.y += p.dy; p.dy += 0.1; p.alpha -= 0.015; ctx.fillStyle = p.color; ctx.globalAlpha = p.alpha; ctx.beginPath(); ctx.arc(p.x, p.y, 2.5, 0, 7); ctx.fill(); });
            particles = particles.filter(p => p.alpha > 0);
            if(particles.length > 0) requestAnimationFrame(ani); else canvas.style.opacity = 0;
        }; ani();
    }

    renderTasks(); updateStatsAndStars(); updateTimeFromInput();
</script>
</body>
</html>

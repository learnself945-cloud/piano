<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Vivace ç·´ç´åŠ©æ‰‹ - é™³æ¬£å®œ 2026</title>
    <style>
        :root { 
            --bg-paper: #fff9f0; --warm-wood: #8c5a44; --cream: #fdf6e3; 
            --warm-pink: #ffdae0; --caramel: #d4a373; --gold: #f1c40f; --alert: #e67e22;
            --milk-tea: #ddc1a7; --light-coffee: #a67c52;
        }
        body { background: var(--bg-paper); font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--warm-wood); }
        .app-card { width: 100%; max-width: 600px; background: white; padding: 25px; border-radius: 30px; border: 8px solid var(--warm-pink); box-shadow: 0 10px 30px rgba(140,90,68,0.1); position: relative; }
        
        .file-manager { display: flex; gap: 8px; margin-bottom: 15px; background: var(--caramel); padding: 10px 20px; border-radius: 50px; color: white; align-items: center; justify-content: center; }
        .file-manager select { background: white; border-radius: 5px; padding: 3px; border: none; color: var(--warm-wood); }

        .timer-section { background: var(--cream); padding: 25px; border-radius: 25px; margin-bottom: 15px; text-align: center; border: 3px solid var(--caramel); }
        .timer-display { font-size: 64px; font-family: 'Verdana', sans-serif; font-weight: bold; color: var(--warm-wood); margin: 5px 0; }
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--caramel); width: 100%; transition: width 1s linear; }

        .recorder-section { background: #fff; padding: 15px; border-radius: 20px; border: 2px solid var(--warm-pink); margin-bottom: 20px; text-align: center; }
        .rec-active { color: #e74c3c; font-weight: bold; animation: blink 1s infinite; margin-bottom: 5px; display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        audio { width: 100%; margin-top: 10px; height: 35px; }

        .reward-banner { background: var(--milk-tea); color: var(--warm-wood); padding: 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #c8ab8f; }
        .star-display { font-size: 36px; color: var(--gold); margin-bottom: 5px; min-height: 45px; word-break: break-all; }

        .stats-section { background: rgba(255, 218, 224, 0.3); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed var(--caramel); }
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-box { font-size: 11px; background: white; padding: 8px 2px; border-radius: 12px; border: 1px solid var(--warm-pink); }
        .day-box.today { background: var(--caramel); color: white; border: 1px solid var(--warm-wood); }

        .scale-config-area { background: var(--warm-pink); padding: 15px; border-radius: 20px; margin-bottom: 20px; }
        .sync-area { background: var(--milk-tea); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--light-coffee); }
        
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { border: 2px solid var(--warm-pink); padding: 15px; border-radius: 20px; background: white; text-align: center; }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px; border: 1px solid #f0e6d2; gap: 10px; }
        .task-text { flex: 1; font-size: 15px; color: var(--warm-wood); cursor: pointer; }

        .teacher-note-area { margin-top: 20px; padding: 15px; background: #fffcf5; border: 2px solid var(--warm-pink); border-radius: 15px; }
        .teacher-note-area h4 { margin: 0 0 10px 0; color: var(--warm-wood); font-size: 16px; border-left: 5px solid var(--caramel); padding-left: 10px; }
        #teacherNoteDisplay { min-height: 50px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: #555; }
        #noteEditorContainer { display: none; flex-direction: column; gap: 10px; }
        #teacherNoteEdit { width: 100%; min-height: 80px; border: 1px solid var(--caramel); border-radius: 8px; padding: 8px; font-family: inherit; font-size: 14px; box-sizing: border-box; }

        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; padding: 8px 12px; }
        .btn-warm { background: var(--caramel); color: white; }
        .btn-soft { background: var(--warm-pink); color: var(--warm-wood); }
        .btn-pdf { background: #5a8dee; color: white; font-size: 11px; }
        .btn-danger { background: var(--light-coffee); color: white; font-size: 10px; display: none; margin-left: 10px; }
        .btn-rec { background: #e74c3c; color: white; }
        
        .counter-btn { 
            width: 80px; height: 80px; border-radius: 50%; 
            background: var(--warm-pink); display: flex; align-items: center; 
            justify-content: center; cursor: pointer; border: 4px solid white; 
            font-size: 32px; font-weight: bold; margin: 10px auto; 
            color: var(--warm-wood); transition: transform 0.1s;
            user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .counter-btn:active { transform: scale(0.9); }

        .footer-credit { margin-top: 25px; font-size: 14px; color: var(--caramel); font-weight: bold; }
        input, select { padding: 4px; border-radius: 8px; border: 1px solid #d4a373; outline: none; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .file-manager, .timer-section, .recorder-section, .tools-grid, .scale-config-area, .sync-area, #weekStartDate, .btn-warm, .btn-soft, .btn-danger, .btn-pdf, .task-item button, .footer-credit, input[type="text"], input[type="number"], select, textarea { display: none !important; }
            body { background: white; padding: 0; }
            .app-card { border: none; box-shadow: none; width: 100%; max-width: 100%; padding: 0; }
            .teacher-note-area { border: 1px solid #ccc; background: white; margin-top: 30px; }
            #noteEditorContainer { display: none !important; }
            #teacherNoteDisplay { display: block !important; }
            h3 { color: black !important; border-color: black !important; margin-top: 20px !important; }
            .reward-banner { border: 1px solid #ddd; background: #fff !important; }
            .star-display { color: #f1c40f !important; font-size: 24px; }
            .task-item { border-bottom: 1px solid #eee; padding: 10px 0; border-radius: 0; }
            input[type="checkbox"] { display: inline-block !important; width: 18px; height: 18px; border: 1px solid #888; margin-right: 10px; }
        }
    </style>
</head>
<body>

<div class="file-manager">
    <span>ğŸ“ å­¸ç”Ÿï¼š</span>
    <select id="saveSelect" onchange="switchSave()"></select>
    <button onclick="createNewSave()" style="background:#555; color:white; font-size:11px;">â• æ–°å¢</button>
</div>

<div class="app-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: var(--warm-wood);" id="displayName">ğŸ“Š ç·´ç´ç´€éŒ„</h3>
        <span style="background:var(--caramel); color:white; padding:4px 12px; border-radius:15px; font-size:12px;" id="weekTotalDisplay">ç¸½è¨ˆ: 0 åˆ†</span>
    </div>

    <div class="timer-section">
        <div style="font-size: 13px; color: var(--caramel); margin-bottom: 5px;" id="currentTaskTitle">è«‹é»é¸ä¸‹æ–¹ç·´ç¿’é …ç›®</div>
        <div class="timer-display" id="mainClock">20:00</div>
        <div class="progress-container"><div class="progress-bar" id="timerBar"></div></div>
        <div style="display: flex; justify-content: center; gap: 8px; align-items: center;">
            <input type="number" id="setMinutes" value="20" min="1" style="width: 40px; text-align: center;"> åˆ†
            <button class="btn-warm" id="timerBtn" onclick="toggleTimer()">â–¶ é–‹å§‹</button>
            <button class="btn-soft" onclick="resetTimer()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <div class="reward-banner">
        <div id="starContainer" class="star-display"></div>
        <div style="font-size: 11px; opacity: 0.9;">
            â­ æ¯ <input type="number" id="starThreshold" value="30" min="1" disabled style="width: 30px; border:none; background:transparent; color:inherit; text-align:center; font-weight:bold;"> åˆ†é˜å¾—ä¸€æ˜Ÿ
            <button onclick="toggleStarLock()" id="lockBtn" style="padding: 2px 6px; font-size: 9px; background: #744b35; color: white;">ğŸ”‘ ç®¡ç†</button>
            <button onclick="resetStars()" id="resetStarBtn" class="btn-danger">ğŸ—‘ï¸ æ˜Ÿæ˜Ÿæ­¸é›¶</button>
        </div>
    </div>
    
    <div class="stats-section">
        <div style="text-align: center; font-size: 11px; margin-bottom: 10px; color: var(--caramel);">
            ğŸ“… æ¯é€±èµ·å§‹æ—¥ï¼š<input type="date" id="weekStartDate" onchange="saveAndRefresh()">
        </div>
        <div class="stats-grid" id="statsGrid"></div>
    </div>

    <div class="recorder-section">
        <h4 style="margin: 0 0 10px 0; font-size: 15px;">ğŸ™ï¸ è‡ªæˆ‘æª¢è½éŒ„éŸ³å®¤</h4>
        <div id="recIndicator" class="rec-active">ğŸ”´ Recording...</div>
        <div style="display: flex; justify-content: center; gap: 8px;">
            <button id="startRec" class="btn-warm" onclick="startRecording()" style="background: #2ecc71;">âº éŒ„éŸ³</button>
            <button id="stopRec" class="btn-rec" onclick="stopRecording()" disabled>â¹ åœæ­¢</button>
            <button id="downloadRec" class="btn-soft" onclick="downloadAudio()" style="display:none;">ğŸ’¾ ä¸‹è¼‰</button>
        </div>
        <audio id="audioPlayback" controls style="display:none;"></audio>
    </div>

    <div class="tools-grid">
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ¥ ç¯€æ‹å™¨</h4>
            <div style="font-size: 11px; margin-bottom: 5px;">
                BPM: <input type="number" id="bpmInput" value="100" style="width:40px;">
                <select id="beatType" onchange="currentBeat=0" style="width:55px;"><option value="0">ç„¡</option><option value="2">2/4</option><option value="3">3/4</option><option value="4">4/4</option><option value="6">6/8</option></select>
            </div>
            <input type="range" id="volSlider" style="width:100%; accent-color:var(--caramel);" min="0" max="1" step="0.1" value="0.7">
            <button class="btn-warm" onclick="toggleMetronome()" id="metroBtn" style="width:100%; margin-top:5px;">å•Ÿå‹•</button>
        </div>
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ”¢ è¨ˆæ¬¡</h4>
            <div class="counter-btn" onclick="handleCounterClick()" id="countNum">5</div>
            <input type="number" id="customCountSet" value="5" min="1" style="width: 35px; text-align: center;" oninput="syncNewStartValue()"> æ¬¡
        </div>
    </div>

    <div class="scale-config-area">
        <h4 style="margin:0 0 10px 0">âœ¨ éŸ³éš 24 å¤§å°èª¿</h4>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <select id="scaleKey" style="flex:1">
                <optgroup label="å¤§èª¿ Major"><option>C Major</option><option>G Major</option><option>D Major</option><option>A Major</option><option>E Major</option><option>B Major</option><option>F# Major</option><option>C# Major</option><option>F Major</option><option>Bb Major</option><option>Eb Major</option><option>Ab Major</option><option>Db Major</option><option>Gb Major</option><option>Cb Major</option></optgroup>
                <optgroup label="å°èª¿ minor"><option>a minor</option><option>e minor</option><option>b minor</option><option>f# minor</option><option>c# minor</option><option>g# minor</option><option>d# minor</option><option>a# minor</option><option>d minor</option><option>g minor</option><option>c minor</option><option>f minor</option><option>bb minor</option><option>eb minor</option><option>ab minor</option></optgroup>
            </select>
            é€Ÿåº¦: <input type="number" id="scaleBpm" value="60" style="width: 40px;">
            <button class="btn-warm" onclick="addScaleTask()">åŠ å…¥</button>
        </div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="newTaskInput" placeholder="è‡ªè¨‚ç·´ç¿’å…§å®¹..." style="flex: 1;">
            <button class="btn-warm" onclick="addTask()">æ–°å¢</button>
        </div>
    </div>

    <div class="sync-area">
        <h4 style="margin:0 0 10px 0">ğŸ“‹ ç¯„æœ¬ç®¡ç†èˆ‡æ´¾ç™¼</h4>
        <div style="display:flex; flex-direction: column; gap:8px; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="bookInput" list="bookList" placeholder="æ›¸å(å¦‚:èŠ¬è²çˆ¾)" style="flex:1">
                <datalist id="bookList"></datalist>
                <input type="text" id="pageInput" placeholder="é æ•¸/ç·¨è™Ÿ" style="width: 80px;">
                <button class="btn-warm" onclick="applySmartTemplate()">æ´¾ç™¼</button>
            </div>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="exportData()" class="btn-soft" style="flex:1; background: white; border: 1px solid var(--caramel);">ğŸ“¤ åˆ†äº«ä»£ç¢¼</button>
            <button onclick="importData()" class="btn-soft" style="flex:1; background: white; border: 1px solid var(--caramel);">ğŸ“¥ åŒ¯å…¥åŠŸèª²</button>
            <button onclick="window.print()" class="btn-pdf" style="flex:1;">ğŸ–¨ï¸ è¼¸å‡º PDF</button>
        </div>
    </div>

    <h3 style="color: var(--warm-wood); border-left: 5px solid var(--caramel); padding-left: 10px; margin-top: 25px; margin-bottom: 15px;">ğŸ“… æ¯æ—¥ç·´ç¿’é …ç›®</h3>
    <ul class="task-list" id="taskList"></ul>

    <div class="teacher-note-area">
        <h4>ğŸ“ æœ¬é€±è©•åƒ¹åŠæ³¨æ„äº‹é …</h4>
        <div id="teacherNoteDisplay"></div>
        <div id="noteEditorContainer">
            <div style="display:flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                <div style="font-size: 11px; color: var(--caramel);">
                    å¿«é€Ÿè©•èªï¼š
                    <select id="quickNotes" onchange="addQuickNote()" style="font-size: 11px; width: 100px;">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                    </select>
                </div>
                <button onclick="addNewQuickNote()" style="font-size: 10px; background: #8c5a44; color: white; padding: 2px 6px;">â• æ–°å¢è©•åƒ¹</button>
            </div>
            <textarea id="teacherNoteEdit" placeholder="åœ¨æ­¤è¼¸å…¥è©•åƒ¹..."></textarea>
        </div>
    </div>
</div>

<div class="footer-credit">è¨­è¨ˆè€…ï¼šé™³æ¬£å®œ 2026</div>

<script>
    let mediaRecorder, audioChunks = [], audioBlob, audioUrl;
    let audioCtx = null, metroRunning = false, nextTickTime = 0, currentBeat = 0, timerID = null;
    let timerInterval = null, timeLeft = 1200, totalTimeSet = 1200, isTimerRunning = false, isStarLocked = true;
    let count = 5;
    const MASTER_PWD = "888";
    
    const DEFAULT_BOOKS = ["å“ˆè¾²ï¼šNO", "èŠ¬è²çˆ¾", "å½ˆå”±æ›²é›†", "ä½ˆçˆ¾æ ¼å½Œå‹’", "è¦–å¥"];
    const DEFAULT_NOTES = [
        { label: "ğŸŒŸ é€²æ­¥å¾ˆå¤§", content: "æœ¬é€±é€²æ­¥å¾ˆå¤§ï¼Œè«‹ç¹¼çºŒä¿æŒï¼" },
        { label: "ğŸ‘ è¡¨ç¾å„ªç•°", content: "ç·´ç¿’ç©©å®šåº¦é«˜ï¼Œè¡¨ç¾å„ªç•°ã€‚" },
        { label: "ğŸ¥ ç¯€å¥åŠ å¼·", content: "ç¯€å¥æ„Ÿç¨å¾®ä¸ç©©ï¼Œå»ºè­°å¤šè·Ÿç¯€æ‹å™¨ç·´ç¿’ã€‚" },
        { label: "ğŸ–ï¸ æ³¨æ„æ‰‹å‹", content: "æ‰‹å‹è¦æ³¨æ„ï¼Œé¿å…æ‰‹æŒ‡å¡Œé™·ã€‚" },
        { label: "ğŸ¼ æ¨‚å¥è™•ç†", content: "æ¨‚å¥è™•ç†å¯ä»¥å†æ›´ç´°ç·»ä¸€é»ã€‚" }
    ];

    let currentSaveName = localStorage.getItem('v_save_v30') || 'é è¨­å­˜æª”';
    let saveList = JSON.parse(localStorage.getItem('v_list_v30')) || ['é è¨­å­˜æª”'];
    let appData = {};

    function init() { loadData(); updateSaveSelect(); updateBookDatalist(); updateNoteSelect(); renderUI(); resetTimer(); }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioUrl = URL.createObjectURL(audioBlob);
                const p = document.getElementById('audioPlayback');
                p.src = audioUrl; p.style.display = 'block';
                document.getElementById('downloadRec').style.display = 'inline-block';
            };
            mediaRecorder.start();
            document.getElementById('startRec').disabled = true;
            document.getElementById('stopRec').disabled = false;
            document.getElementById('recIndicator').style.display = 'block';
        } catch (err) { alert("ç„¡æ³•é–‹å•Ÿéº¥å…‹é¢¨ã€‚"); }
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('startRec').disabled = false;
        document.getElementById('stopRec').disabled = true;
        document.getElementById('recIndicator').style.display = 'none';
    }

    function downloadAudio() {
        const a = document.createElement('a'); a.href = audioUrl;
        a.download = `éŒ„éŸ³_${currentSaveName}_${new Date().getTime()}.webm`; a.click();
    }

    function loadData() {
        const raw = localStorage.getItem(`v_data_v30_${currentSaveName}`);
        appData = raw ? JSON.parse(raw) : { tasks: [], stats: {}, threshold: 30, weekStart: new Date().toISOString().split('T')[0], baseMinutes: 0, teacherNote: "" };
        document.getElementById('starThreshold').value = appData.threshold || 30;
        document.getElementById('weekStartDate').value = appData.weekStart;
        document.getElementById('displayName').innerText = currentSaveName + " - ç·´ç´ç´€éŒ„";
        document.getElementById('teacherNoteEdit').value = appData.teacherNote || "";
        syncNewStartValue();
    }

    function saveData() {
        appData.threshold = document.getElementById('starThreshold').value;
        appData.weekStart = document.getElementById('weekStartDate').value;
        appData.teacherNote = document.getElementById('teacherNoteEdit').value;
        localStorage.setItem(`v_data_v30_${currentSaveName}`, JSON.stringify(appData));
        localStorage.setItem('v_list_v30', JSON.stringify(saveList));
        localStorage.setItem('v_save_v30', currentSaveName);
    }

    function updateBookDatalist() {
        const dl = document.getElementById('bookList'); dl.innerHTML = "";
        let customBooks = JSON.parse(localStorage.getItem('v_custom_books_v30')) || [];
        Array.from(new Set([...DEFAULT_BOOKS, ...customBooks])).forEach(name => {
            const opt = document.createElement('option'); opt.value = name; dl.appendChild(opt);
        });
    }

    function applySmartTemplate() {
        const bookInput = document.getElementById('bookInput'); const pageInput = document.getElementById('pageInput');
        const book = bookInput.value.trim(); const page = pageInput.value.trim();
        if (!book) return alert("è«‹è¼¸å…¥æ•™æåç¨±");
        if (!DEFAULT_BOOKS.includes(book)) {
            let custom = JSON.parse(localStorage.getItem('v_custom_books_v30')) || [];
            if (!custom.includes(book)) { custom.push(book); localStorage.setItem('v_custom_books_v30', JSON.stringify(custom)); }
        }
        appData.tasks.push({ text: book + (page ? " " + page : "") });
        bookInput.value = ""; pageInput.value = "";
        saveAndRefresh(); updateBookDatalist();
    }

    function updateNoteSelect() {
        const sel = document.getElementById('quickNotes');
        sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
        let customNotes = JSON.parse(localStorage.getItem('v_custom_notes_v30')) || [];
        let allNotes = [...DEFAULT_NOTES, ...customNotes];
        allNotes.forEach(item => {
            const opt = document.createElement('option'); opt.value = item.content; opt.text = item.label; sel.appendChild(opt);
        });
    }

    function addQuickNote() {
        const sel = document.getElementById('quickNotes');
        if (sel.value) {
            const editor = document.getElementById('teacherNoteEdit');
            editor.value += (editor.value ? "\n" : "") + sel.value;
            sel.value = ""; 
        }
    }

    function addNewQuickNote() {
        const content = prompt("è«‹è¼¸å…¥å®Œæ•´çš„é•·è©•èªï¼š");
        if (content) {
            const label = prompt("è«‹è¼¸å…¥é¡¯ç¤ºç”¨çš„ç°¡ç¨±ï¼ˆå»ºè­°4å€‹å­—ï¼‰ï¼š", content.substring(0, 4));
            if (label) {
                let customNotes = JSON.parse(localStorage.getItem('v_custom_notes_v30')) || [];
                customNotes.push({ label: label, content: content });
                localStorage.setItem('v_custom_notes_v30', JSON.stringify(customNotes));
                updateNoteSelect();
            }
        }
    }

    function renderUI() {
        const grid = document.getElementById('statsGrid'); grid.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];
        const start = new Date(appData.weekStart);
        let weekTotal = 0;
        for (let i = 0; i < 7; i++) {
            const curr = new Date(start); curr.setDate(start.getDate() + i);
            const dStr = curr.toISOString().split('T')[0];
            const sec = appData.stats[dStr] || 0; weekTotal += sec;
            const box = document.createElement('div');
            box.className = `day-box ${dStr === todayStr ? 'today' : ''}`;
            box.innerHTML = `<div>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][curr.getDay()]}</div><b>${Math.round(sec/60)}m</b>`;
            grid.appendChild(box);
        }
        document.getElementById('weekTotalDisplay').innerText = `ç¸½è¨ˆ: ${Math.floor(weekTotal/60)} åˆ†`;
        const stars = Math.floor(Math.max(0, Math.floor(weekTotal/60) - (appData.baseMinutes || 0)) / (parseInt(appData.threshold) || 30));
        document.getElementById('starContainer').innerHTML = 'â­'.repeat(stars) || 'âœ¨';
        const list = document.getElementById('taskList'); list.innerHTML = '';
        appData.tasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = `task-item`;
            li.innerHTML = `<input type="checkbox"><span class="task-text" onclick="handleTaskEdit(${i})">${t.text}</span><button onclick="deleteTask(${i})" style="color:#ccc; background:none; font-size:10px;">âœ•</button>`;
            list.appendChild(li);
        });
        document.getElementById('teacherNoteDisplay').innerText = appData.teacherNote || "";
    }

    function handleCounterClick() {
        const startVal = parseInt(document.getElementById('customCountSet').value) || 5;
        if (count > 1) { count--; playBeep(1000, 0.1); document.getElementById('countNum').innerText = count; }
        else { count = 0; document.getElementById('countNum').innerText = 0; playBeep(1600, 0.4); setTimeout(() => { count = startVal; document.getElementById('countNum').innerText = count; }, 500); }
    }
    function playBeep(f, d) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(0.15, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
    }
    function toggleMetronome() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (metroRunning) { window.cancelAnimationFrame(timerID); metroRunning = false; document.getElementById('metroBtn').innerText = "å•Ÿå‹•"; }
        else { currentBeat = 0; nextTickTime = audioCtx.currentTime; scheduler(); metroRunning = true; document.getElementById('metroBtn').innerText = "åœæ­¢"; }
    }
    function scheduler() {
        while (nextTickTime < audioCtx.currentTime + 0.1) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            const b = parseInt(document.getElementById('beatType').value);
            const a = (b > 0 && currentBeat === 0);
            const userVol = parseFloat(document.getElementById('volSlider').value);
            o.frequency.setValueAtTime(a ? 1200 : 800, nextTickTime); g.gain.setValueAtTime(a ? userVol*0.8 : userVol*0.3, nextTickTime);
            g.gain.exponentialRampToValueAtTime(0.001, nextTickTime + 0.05); o.connect(g); g.connect(audioCtx.destination); o.start(nextTickTime); o.stop(nextTickTime + 0.05);
            nextTickTime += 60.0 / (document.getElementById('bpmInput').value || 100); if (b > 0) currentBeat = (currentBeat + 1) % b;
        }
        timerID = window.requestAnimationFrame(scheduler);
    }
    function syncNewStartValue() { count = parseInt(document.getElementById('customCountSet').value) || 5; document.getElementById('countNum').innerText = count; }
    function toggleStarLock() {
        if (isStarLocked) {
            if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š") === MASTER_PWD) {
                isStarLocked = false; document.getElementById('starThreshold').disabled = false; document.getElementById('lockBtn').innerText = "âœ… å„²å­˜";
                document.getElementById('resetStarBtn').style.display = "inline-block"; document.getElementById('teacherNoteDisplay').style.display = "none";
                document.getElementById('noteEditorContainer').style.display = "flex";
            }
        } else {
            isStarLocked = true; document.getElementById('starThreshold').disabled = true; document.getElementById('lockBtn').innerText = "ğŸ”‘ ç®¡ç†";
            document.getElementById('resetStarBtn').style.display = "none"; document.getElementById('teacherNoteDisplay').style.display = "block";
            document.getElementById('noteEditorContainer').style.display = "none"; saveAndRefresh();
        }
    }
    function resetTimer() { clearInterval(timerInterval); isTimerRunning = false; document.getElementById('timerBtn').innerText = "â–¶ é–‹å§‹"; timeLeft = (parseInt(document.getElementById('setMinutes').value) || 20) * 60; totalTimeSet = timeLeft; updateClockDisplay(); document.getElementById('timerBar').style.width = "100%"; }
    function toggleTimer() {
        if (!isTimerRunning) {
            isTimerRunning = true; document.getElementById('timerBtn').innerText = "â¸ æš«åœ";
            timerInterval = setInterval(() => {
                timeLeft--; updateClockDisplay(); document.getElementById('timerBar').style.width = (timeLeft/totalTimeSet)*100 + "%";
                if (timeLeft <= 0) { clearInterval(timerInterval); [523, 659, 783].forEach((f, i) => setTimeout(() => playBeep(f, 0.5), i * 200)); saveTimeProgress(); alert("ğŸ•’ æ™‚é–“åˆ°ï¼"); resetTimer(); }
            }, 1000);
        } else { isTimerRunning = false; document.getElementById('timerBtn').innerText = "â–¶ ç¹¼çºŒ"; clearInterval(timerInterval); }
    }
    function updateClockDisplay() { const m = Math.floor(timeLeft / 60).toString().padStart(2, '0'); const s = (timeLeft % 60).toString().padStart(2, '0'); document.getElementById('mainClock').innerText = `${m}:${s}`; }
    function saveTimeProgress() { const today = new Date().toISOString().split('T')[0]; appData.stats[today] = (appData.stats[today] || 0) + totalTimeSet; saveAndRefresh(); }
    function addScaleTask() { appData.tasks.push({text: `ğŸ¹ éŸ³éšï¼š${document.getElementById('scaleKey').value} (${document.getElementById('scaleBpm').value} BPM)`}); saveAndRefresh(); }
    function addTask() { const v = document.getElementById('newTaskInput').value; if(v){ appData.tasks.push({text:v}); document.getElementById('newTaskInput').value=''; saveAndRefresh(); } }
    function deleteTask(i) { appData.tasks.splice(i,1); saveAndRefresh(); }
    function handleTaskEdit(i) { const newText = prompt("ç·¨è¼¯ç·´ç¿’é …ç›®ï¼š", appData.tasks[i].text); if (newText !== null && newText.trim() !== "") { appData.tasks[i].text = newText; saveAndRefresh(); } }
    function resetStars() { if (confirm("ç¢ºå®šæ˜Ÿæ˜Ÿæ­¸é›¶å—ï¼Ÿ")) { const start = new Date(appData.weekStart); let totalSec = 0; for (let i = 0; i < 7; i++) { const curr = new Date(start); curr.setDate(start.getDate() + i); totalSec += (appData.stats[curr.toISOString().split('T')[0]] || 0); } appData.baseMinutes = Math.floor(totalSec / 60); saveAndRefresh(); } }
    function saveAndRefresh() { saveData(); renderUI(); }
    function updateSaveSelect() { const s = document.getElementById('saveSelect'); s.innerHTML=''; saveList.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.text=n; if(n===currentSaveName) o.selected=true; s.add(o); }); }
    function switchSave() { currentSaveName=document.getElementById('saveSelect').value; init(); }
    function createNewSave() { const n=prompt("è¼¸å…¥æ–°å­¸ç”Ÿåç¨±ï¼š"); if(n && !saveList.includes(n)){ saveList.push(n); currentSaveName=n; appData={tasks:[], stats:{}, threshold:30, weekStart:new Date().toISOString().split('T')[0], baseMinutes:0, teacherNote: ""}; saveData(); init(); } }
    function exportData() { try { const exportObj = { tasks: appData.tasks, teacherNote: appData.teacherNote, source: currentSaveName }; const code = btoa(encodeURIComponent(JSON.stringify(exportObj))); const temp = document.createElement("input"); document.body.appendChild(temp); temp.value = code; temp.select(); document.execCommand("copy"); document.body.removeChild(temp); alert("ä»£ç¢¼å·²è¤‡è£½ï¼"); } catch (e) { alert("åŒ¯å‡ºå¤±æ•—"); } }
    function importData() { const code = prompt("è«‹è²¼ä¸Šåˆ†äº«ä»£ç¢¼ï¼š"); if (!code) return; try { const data = JSON.parse(decodeURIComponent(atob(code))); if (confirm(`åŒ¯å…¥åŠŸèª²å—ï¼Ÿ`)) { appData.tasks = data.tasks; appData.teacherNote = data.teacherNote; saveAndRefresh(); alert("åŒ¯å…¥æˆåŠŸï¼"); } } catch (e) { alert("ä»£ç¢¼ç„¡æ•ˆ"); } }

    init();
</script>
</body>
</html>

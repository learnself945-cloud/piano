<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Vivace ç·´ç´åŠ©æ‰‹ - æ˜Ÿæ˜Ÿç…™ç«æ…¶ç¥ç‰ˆ</title>
    <style>
        :root { 
            --bg-paper: #fdf6e3; --piano-black: #2c3e50; --soft-pink: #ffdae0; 
            --mint: #b8e994; --gold: #d4a373; --wood: #8c5a44; --star-color: #f1c40f;
        }
        body { 
            background: var(--bg-paper); font-family: 'Microsoft JhengHei', sans-serif; 
            display: flex; flex-direction: column; align-items: center; padding: 20px; 
            color: var(--piano-black); 
            overflow-x: hidden; /* é˜²æ­¢ç…™ç«æº¢å‡ºé€ æˆæ»¾å‹•æ¢ */
        }
        .app-card { 
            width: 100%; max-width: 600px; background: #fffaf0; padding: 30px; 
            border-radius: 30px; border: 8px solid var(--soft-pink); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            position: relative; /* ç‚ºäº†è®“ç…™ç«canvasèƒ½å®šä½åœ¨å…¶ä¸Šæ–¹ */
            z-index: 10; /* ç¢ºä¿å…§å®¹åœ¨ç…™ç«ä¹‹ä¸Š */
        }
        
        /* çµ±è¨ˆèˆ‡çå‹µå€ */
        .stats-section { 
            background: rgba(255, 218, 224, 0.3); padding: 15px; border-radius: 20px; 
            margin-bottom: 15px; border: 2px dashed var(--gold); 
        }
        .stats-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; 
            text-align: center; margin-bottom: 15px; 
        }
        .day-box { 
            font-size: 11px; background: white; padding: 8px 2px; border-radius: 12px; 
            border: 1px solid var(--soft-pink); 
        }
        .day-box.today { background: var(--mint); border: 2px solid var(--wood); }
        
        .reward-banner { 
            background: var(--piano-black); color: white; padding: 12px; border-radius: 15px; 
            text-align: center; 
        }
        .star-display { 
            font-size: 24px; color: var(--star-color); margin-top: 5px; min-height: 30px; 
        }

        /* æ¸…å–®æ¨£å¼ */
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { 
            display: flex; align-items: center; padding: 12px; background: white; 
            border-radius: 15px; margin-bottom: 8px; border: 1px solid #eee; gap: 10px; 
        }
        .task-text { flex: 1; font-size: 16px; }
        .completed { background: #f0f0f0; }
        .completed .task-text { text-decoration: line-through; color: #aaa; }

        /* å·¥å…·å€ */
        .timer-section { 
            text-align: center; background: var(--piano-black); color: #fff; padding: 20px; 
            border-radius: 20px; margin-bottom: 20px; 
        }
        .timer-display { 
            font-size: 50px; font-weight: bold; font-family: monospace; color: var(--mint); 
        }
        .tools-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; 
        }
        .tool-box { 
            border: 2px solid var(--soft-pink); padding: 15px; border-radius: 20px; 
            background: white; text-align: center; 
        }
        
        button { 
            cursor: pointer; border: none; border-radius: 12px; padding: 10px 15px; 
            font-weight: bold; transition: 0.2s; 
        }
        button:active { transform: scale(0.95); }
        .btn-main { background: var(--wood); color: white; }
        .btn-mint { background: var(--mint); color: var(--wood); }
        
        input, select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .volume-label { font-size: 11px; display: block; margin-top: 5px; }

        /* ç…™ç«Canvasæ¨£å¼ */
        #fireworksCanvas {
            position: fixed; /* å›ºå®šåœ¨è¦–çª—ä¸Šå±¤ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            pointer-events: none; /* è®“ç…™ç«ä¸å½±éŸ¿ä¸‹æ–¹é»æ“Š */
            opacity: 0; /* é è¨­éš±è— */
            transition: opacity 0.5s ease-out; /* æ·¡å‡ºæ•ˆæœ */
        }
        #fireworksCanvas.active {
            opacity: 1;
        }
    </style>
</head>
<body>

<div class="app-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: var(--wood);">ğŸ“Š æœ¬é€±ç·´ç´ç´€éŒ„</h3>
        <span style="background:var(--wood); color:white; padding:4px 12px; border-radius:15px; font-size:12px;" id="weekTotalDisplay">ç¸½è¨ˆ: 0 åˆ†é˜</span>
    </div>
    
    <div class="stats-section">
        <div class="stats-grid" id="statsGrid"></div>
        
        <div class="reward-banner">
            <div style="font-size: 13px; letter-spacing: 1px;">ğŸ† ç·´ç¿’çå‹µ (æ¯ 30 åˆ†é˜ç²å¾— â­)</div>
            <div id="starContainer" class="star-display"></div>
            <div id="nextStarInfo" style="font-size: 10px; color: #aaa; margin-top: 3px;"></div>
        </div>
    </div>

    <div class="timer-section">
        <div class="timer-display" id="timeShow">25:00</div>
        <button class="btn-mint" onclick="toggleTimer()" id="timerBtn" style="margin-top:10px">é–‹å§‹ç·´ç¿’</button>
        <button onclick="resetTimer()" style="background:transparent; color:white; border:1px solid white; font-size:12px;">é‡è¨­</button>
    </div>

    <div class="tools-grid">
        <div class="tool-box">
            <h4 style="margin:0">ğŸ¥ ç¯€æ‹å™¨</h4>
            <div style="font-size: 11px; margin: 5px 0;">BPM: <input type="number" id="bpmInput" value="100" style="width: 45px;"></div>
            <select id="soundType" style="font-size:11px; margin-bottom:5px; width: 100%;">
                <option value="click">æ‰“é»æ¿ (Click)</option>
                <option value="sticks">é¼“æ£’ (Sticks)</option>
                <option value="sharp">é›»å­ (Sharp)</option>
            </select>
            <span class="volume-label">ğŸ”Š éŸ³é‡èª¿ç¯€</span>
            <input type="range" id="volInput" min="0" max="2" step="0.1" value="1.5" style="width: 100%; margin-bottom: 8px;">
            <button class="btn-main" onclick="toggleMetronome()" id="metroBtn" style="width:100%;">å•Ÿå‹•</button>
        </div>
        <div class="tool-box">
            <h4 style="margin:0 0 5px 0">ğŸ”¢ è¨ˆæ¬¡</h4>
            <div onclick="changeCount(-1)" style="width:60px; height:60px; border-radius:50%; background:var(--soft-pink); margin:0 auto; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <span id="countNum" style="font-size:24px; font-weight:bold">5</span>
            </div>
            <button onclick="resetCount()" style="background:none; text-decoration:underline; font-size:12px; margin-top:10px; color: var(--wood); font-weight: bold;">é‡ç½®æ¬¡æ•¸</button>
        </div>
    </div>

    <div style="background: var(--soft-pink); padding: 15px; border-radius: 20px; margin-bottom: 20px;">
        <h4 style="margin:0 0 10px 0">âœ¨ æ–°å¢ç·´ç¿’</h4>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <select id="scaleKey" style="flex:1">
                <option>C Major</option><option>G Major</option><option>D Major</option><option>A Major</option><option>E Major</option><option>B Major</option><option>F Major</option><option>Bb Major</option><option>Eb Major</option><option>Ab Major</option><option>a minor</option><option>e minor</option><option>d minor</option><option>g minor</option>
            </select>
            <input type="number" id="scaleBpmInput" value="120" style="width: 50px;">
            <button class="btn-main" onclick="addScaleTask()">åŠ å…¥</button>
        </div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="newTaskInput" placeholder="æ›²ç›®åç¨±..." style="flex: 1;">
            <button class="btn-main" onclick="addTask()">æ–°å¢</button>
        </div>
    </div>

    <h3 style="border-left: 5px solid var(--gold); padding-left: 10px;">ğŸ“ ä»Šæ—¥ç·´ç¿’æ¸…å–®</h3>
    <ul class="task-list" id="taskList"></ul>

    <button style="background:#555; color:white; width:100%; margin-top:20px; height:45px; font-size:16px;" onclick="printList()">ğŸ“„ åˆ—å° / å¦å­˜ PDF</button>
</div>

<canvas id="fireworksCanvas"></canvas>

<script>
    let audioCtx = null, timeLeft = 1500, timerRunning = false, timerInterval = null, metroRunning = false, metroInterval = null, count = 5;
    let savedTasks = JSON.parse(localStorage.getItem('vivace_reward_tasks')) || [];
    let weeklyData = JSON.parse(localStorage.getItem('vivace_reward_stats')) || {};
    let lastStarCount = 0; // ç”¨æ–¼è¿½è¹¤ä¸Šæ¬¡ç²å¾—çš„æ˜Ÿæ˜Ÿæ•¸é‡ï¼Œé¿å…é‡è¤‡è§¸ç™¼

    // ç…™ç«Canvasç›¸é—œè®Šæ•¸
    const canvas = document.getElementById('fireworksCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const FIREWORK_SOUND_URL = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARJxAAABAAABeBAAACAEAAIEAAABCaXQAAAABAAAAIAAAAABkYXRhAAAAAA=='; // ç°¡çŸ­æ…¶ç¥éŸ³æ•ˆï¼Œdata URL
    let fireworkAudioBuffer = null;

    // --- éŸ³è¨Šåˆå§‹åŒ– ---
    function initAudio() { 
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            loadFireworkSound(); // é è¼‰ç…™ç«éŸ³æ•ˆ
        }
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
    }

    // --- è¼‰å…¥ç…™ç«éŸ³æ•ˆ ---
    function loadFireworkSound() {
        fetch(FIREWORK_SOUND_URL)
            .then(response => response.arrayBuffer())
            .then(buffer => audioCtx.decodeAudioData(buffer))
            .then(decodedBuffer => {
                fireworkAudioBuffer = decodedBuffer;
            })
            .catch(e => console.error("Error decoding firework sound", e));
    }

    // --- æ’­æ”¾ç…™ç«éŸ³æ•ˆ ---
    function playFireworkSound() {
        if (fireworkAudioBuffer && audioCtx) {
            const source = audioCtx.createBufferSource();
            source.buffer = fireworkAudioBuffer;
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.5; // éŸ³é‡é©ä¸­
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(0);
        }
    }

    // --- æ’­æ”¾ç¯€æ‹å™¨/è¨ˆæ¬¡éŸ³æ•ˆ ---
    function playSound(type) {
        initAudio(); // ç¢ºä¿ AudioContext å·²åˆå§‹åŒ–
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        const volume = document.getElementById('volInput').value;

        if (type === 'click') { 
            o.type = 'sine'; o.frequency.setValueAtTime(1800, audioCtx.currentTime); 
            g.gain.setValueAtTime(volume, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05); 
        } else if (type === 'sticks') { 
            o.type = 'triangle'; o.frequency.setValueAtTime(900, audioCtx.currentTime); 
            g.gain.setValueAtTime(volume * 1.5, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1); 
        } else { // sharp for count or electronic sound
            o.type = 'square'; o.frequency.setValueAtTime(1200, audioCtx.currentTime); 
            g.gain.setValueAtTime(volume * 0.6, audioCtx.currentTime); 
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06); 
        }
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.15);
    }

    function getTodayStr() { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
    
    function updateStatsAndStars() {
        const grid = document.getElementById('statsGrid'); grid.innerHTML = '';
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const now = new Date();
        let weekTotalSec = 0;
        
        for (let i = 0; i < 7; i++) {
            const d = new Date(); d.setDate(now.getDate() - now.getDay() + i);
            const dStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
            const sec = weeklyData[dStr] || 0; weekTotalSec += sec;
            const box = document.createElement('div');
            box.className = `day-box ${dStr === getTodayStr() ? 'today' : ''}`;
            box.innerHTML = `<div>${days[i]}</div><div style="font-weight:bold">${Math.round(sec/60)}m</div>`;
            grid.appendChild(box);
        }
        
        const totalMinutes = Math.floor(weekTotalSec / 60);
        document.getElementById('weekTotalDisplay').innerText = `ç¸½è¨ˆ: ${totalMinutes} åˆ†é˜`;
        
        const currentStarCount = Math.floor(totalMinutes / 30);
        const starContainer = document.getElementById('starContainer');
        const nextStarInfo = document.getElementById('nextStarInfo');
        
        starContainer.innerHTML = 'â­'.repeat(currentStarCount);
        if(currentStarCount === 0 && totalMinutes < 30) {
            starContainer.innerHTML = '<span style="color:#555; font-size:14px;">å°šæœªç²å¾—æ˜Ÿæ˜Ÿ</span>';
        }
        
        const remain = 30 - (totalMinutes % 30);
        nextStarInfo.innerText = currentStarCount >= 10 ? "ä½ å¤ªå¼·äº†ï¼é‹¼ç´å¤§å¸«ï¼" : `å†ç·´ç¿’ ${remain} åˆ†é˜å¯ç²å¾—ä¸‹ä¸€é¡†æ˜Ÿæ˜Ÿ`;

        // --- ç…™ç«è§¸ç™¼é‚è¼¯ ---
        if (currentStarCount > lastStarCount && lastStarCount !== 0) { // ç¢ºä¿ä¸æ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œä¸”æ˜Ÿæ˜Ÿæ•¸é‡å¢åŠ 
            triggerFireworks();
            playFireworkSound();
        }
        lastStarCount = currentStarCount; // æ›´æ–°ä¸Šæ¬¡çš„æ˜Ÿæ˜Ÿæ•¸é‡
    }

    function toggleTimer() {
        initAudio();
        if (timerRunning) { clearInterval(timerInterval); timerRunning = false; document.getElementById('timerBtn').innerText = "ç¹¼çºŒç·´ç¿’"; }
        else {
            timerRunning = true; document.getElementById('timerBtn').innerText = "æš«åœ";
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--; updateTimerUI();
                    const t = getTodayStr(); weeklyData[t] = (weeklyData[t] || 0) + 1;
                    localStorage.setItem('vivace_reward_stats', JSON.stringify(weeklyData));
                    if (timeLeft % 10 === 0) updateStatsAndStars();
                } else { clearInterval(timerInterval); alert("æ™‚é–“åˆ°ï¼æ­å–œå®Œæˆä¸€æ®µç·´ç¿’ï¼"); resetTimer(); }
            }, 1000);
        }
    }

    function updateTimerUI() { const m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById('timeShow').innerText = `${m}:${s.toString().padStart(2,'0')}`; }
    function resetTimer() { timeLeft = 1500; updateTimerUI(); timerRunning = false; clearInterval(timerInterval); document.getElementById('timerBtn').innerText = "é–‹å§‹ç·´ç¿’"; }

    function toggleMetronome() {
        initAudio();
        if (metroRunning) { clearTimeout(metroInterval); metroRunning = false; document.getElementById('metroBtn').innerText = "å•Ÿå‹•"; }
        else {
            metroRunning = true; document.getElementById('metroBtn').innerText = "åœæ­¢";
            const trigger = () => { 
                if(!metroRunning) return; 
                playSound(document.getElementById('soundType').value); 
                metroInterval = setTimeout(trigger, 60000/document.getElementById('bpmInput').value); 
            };
            trigger();
        }
    }

    function changeCount(v) { initAudio(); count = Math.max(0, count + v); document.getElementById('countNum').innerText = count; if(v < 0) playSound('sharp'); }
    function resetCount() { count = 5; document.getElementById('countNum').innerText = count; }

    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        savedTasks.forEach((task, index) => {
            const li = document.createElement('li'); li.className = `task-item ${task.completed ? 'completed' : ''}`;
            li.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''} onclick="toggleTask(${index})">
                <span class="task-text">${task.text}</span>
                <button onclick="deleteTask(${index})" style="background:none; color:#ccc; font-size:18px;">âœ•</button>`;
            list.appendChild(li);
        });
        localStorage.setItem('vivace_reward_tasks', JSON.stringify(savedTasks));
    }

    function addTask() { const v = document.getElementById('newTaskInput').value; if(v) { savedTasks.push({text: v, completed: false}); document.getElementById('newTaskInput').value=''; renderTasks(); } }
    function addScaleTask() { const k = document.getElementById('scaleKey').value, b = document.getElementById('scaleBpmInput').value; savedTasks.push({text: `ğŸ¹ éŸ³éš: ${k} (${b} BPM)`, completed: false}); renderTasks(); }
    function toggleTask(index) { savedTasks[index].completed = !savedTasks[index].completed; renderTasks(); }
    function deleteTask(index) { savedTasks.splice(index, 1); renderTasks(); }

    function printList() {
        const win = window.open('', '_blank');
        const date = new Date().toLocaleDateString();
        const totalMin = Math.floor(Object.values(weeklyData).reduce((a, b) => a + b, 0) / 60);
        const stars = 'â­'.repeat(Math.floor(totalMin / 30));
        let items = '';
        savedTasks.forEach(t => { items += `<div style="padding:15px; border-bottom:1px solid #eee; font-size:20px;">${t.completed ? 'â˜‘ï¸' : 'â˜'} ${t.text}</div>`; });
        win.document.write(`<html><head><title>ç·´ç´ç´€éŒ„</title></head><body style="font-family:sans-serif; padding:40px;"><h1 style="text-align:center; border-bottom:2px solid #d4a373; padding-bottom:10px;">ğŸ¹ æ¯æ—¥ç·´ç´ç´€éŒ„æ¸…å–®</h1><p style="text-align:right;">æ—¥æœŸï¼š${date}</p><div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"><strong>æœ¬é€±æˆå°±ï¼š</strong> ${stars} (å…± ${totalMin} åˆ†é˜)</div>${items}</body></html>`);
        win.document.close();
        win.print();
    }

    // --- ç…™ç«å‹•ç•«é‚è¼¯ ---
    // è¨­ç½® Canvas å°ºå¯¸
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ç…™ç«ç²’å­é¡
    class Particle {
        constructor(x, y, color, velocity) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.velocity = velocity;
            this.alpha = 1;
            this.friction = 0.99;
            this.gravity = 0.05;
            this.size = Math.random() * 3 + 1;
        }

        update() {
            this.velocity.x *= this.friction;
            this.velocity.y *= this.friction;
            this.velocity.y += this.gravity;
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.alpha -= 0.005;
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
            ctx.restore();
        }
    }

    // è§¸ç™¼ç…™ç«æ•ˆæœ
    function triggerFireworks() {
        canvas.classList.add('active'); // è®“Canvasæ·¡å…¥
        particles = []; // æ¸…ç©ºä¹‹å‰çš„ç²’å­

        // éš¨æ©Ÿç”Ÿæˆ 3-5 å€‹ç…™ç«ç™¼å°„é»
        const numFireworks = Math.floor(Math.random() * 3) + 3; 
        for (let i = 0; i < numFireworks; i++) {
            const startX = Math.random() * canvas.width;
            const startY = canvas.height; // å¾åº•éƒ¨ç™¼å°„
            const color = `hsl(${Math.random() * 360}, 100%, 50%)`;

            // ç™¼å°„é»ä¸Šå‡
            const firework = {
                x: startX,
                y: startY,
                targetY: Math.random() * (canvas.height / 2) + canvas.height / 4, // ç›®æ¨™é«˜åº¦
                color: color,
                speed: Math.random() * 5 + 3,
                reachedTarget: false
            };
            particles.push(firework);
        }

        let animationId;
        const animate = () => {
            animationId = requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç•«å¸ƒ

            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];

                if (p.alpha !== undefined) { // é€™æ˜¯çˆ†è£‚å¾Œçš„ç²’å­
                    p.update();
                    p.draw();
                } else { // é€™æ˜¯ä¸Šå‡ä¸­çš„ç…™ç«
                    if (!p.reachedTarget) {
                        p.y -= p.speed;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 2, 0, Math.PI * 2, false);
                        ctx.fillStyle = p.color;
                        ctx.fill();

                        if (p.y <= p.targetY) {
                            p.reachedTarget = true;
                            // çˆ†è£‚æˆæ›´å¤šç²’å­
                            for (let j = 0; j < 100; j++) {
                                particles.push(new Particle(
                                    p.x, p.y, p.color,
                                    { x: (Math.random() - 0.5) * Math.random() * 10, y: (Math.random() - 0.5) * Math.random() * 10 }
                                ));
                            }
                            particles.splice(i, 1); // ç§»é™¤ç™¼å°„é»æœ¬èº«
                            i--; // èª¿æ•´ç´¢å¼•
                        }
                    }
                }
            }

            // éæ¿¾æ‰é€æ˜åº¦éä½çš„ç²’å­
            particles = particles.filter(p => p.alpha === undefined || p.alpha > 0);

            if (particles.length === 0) {
                cancelAnimationFrame(animationId);
                canvas.classList.remove('active'); // ç…™ç«çµæŸï¼Œæ·¡å‡ºCanvas
            }
        };

        animate();
    }


    renderTasks(); updateStatsAndStars(); updateTimerUI();
</script>
</body>
</html>
